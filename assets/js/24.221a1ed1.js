(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{231:function(t,e,a){"use strict";a.r(e);var n=a(0),s=Object(n.a)({},function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"docker-from-the-beginning-â€”-part-iii"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-from-the-beginning-â€”-part-iii","aria-hidden":"true"}},[t._v("#")]),t._v(" Docker from the beginningâ€Šâ€”â€Špart III")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/800/1*zzfsCJi6s-79v-4s1AXB1w.jpeg",alt:""}})]),t._v(" "),a("p",[t._v("Follow me on "),a("a",{attrs:{href:"https://twitter.com/chris_noring",target:"_blank",rel:"noopener noreferrer"}},[t._v("Twitter"),a("OutboundLink")],1),t._v(", happy to take your suggestions on topics or improvements /Chris")]),t._v(" "),a("blockquote",[a("p",[t._v("TLDR; this is somewhat of a long read but there is mic drop in there I promise. There is a bit of misery and pain in the middle but we will come out victorius ðŸ˜ƒ")])]),t._v(" "),a("p",[t._v("This article is part of a series:")]),t._v(" "),a("ul",[a("li",[a("p",[a("a",{attrs:{href:"https://dev.to/softchris/docker---from-the-beginning-part-i-28c6https://dev.to/softchris/docker---from-the-beginning-part-i-28c6",target:"_blank",rel:"noopener noreferrer"}},[t._v("Dockerâ€Šâ€”â€Šfrom the beginning part I"),a("OutboundLink")],1),t._v(", this covers why Docker, the basic concepts and the commands we need to manage things like images and containers.")])]),t._v(" "),a("li",[a("p",[a("a",{attrs:{href:"https://dev.to/softchris/docker-from-the-beginning---part-ii-5g8n",target:"_blank",rel:"noopener noreferrer"}},[t._v("Dockerâ€Šâ€”â€Šfrom the beginning, Part II"),a("OutboundLink")],1),t._v(", this is about Volumes and how we can use volumes to persist data but also how we can turn our development environment into a Volume and make our development experience considerably better")])]),t._v(" "),a("li",[a("p",[t._v("Dockerâ€Š â€” â€Šfrom the beginning, Part III, "),a("strong",[t._v("we are here")])])]),t._v(" "),a("li",[a("p",[a("a",{attrs:{href:"https://softchris.github.io/pages/docker-four.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Dockerâ€Šâ€”â€Šfrom the beginning, Part IV"),a("OutboundLink")],1),t._v(", Part IV, this is how we manage more than one service using Docker Compose ( this is 1/2 part on Docker Compose)")])]),t._v(" "),a("li",[a("p",[a("a",{attrs:{href:"https://softchris.github.io/pages/docker-five.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Docker - from the beginning, Part V"),a("OutboundLink")],1),t._v(", this part is the second and concluding part on Docker Compose where we cover Volumes, Environment Variables and working with Databases and Networks")])])]),t._v(" "),a("p",[t._v("This the third part of our series. In this part, we will focus on learning how we work with Databases and Docker together. We will also introduce the concept of "),a("em",[t._v("linking")]),t._v(" as this goes tightly together with working with Databases in a containerized environment.")]),t._v(" "),a("p",[t._v("In this article we will cover the following:")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("Cover some basics about working with MySql")]),t._v(" , itâ€™s always good to cover some basics on managing a database generally and MySql, particularly as this, is the chosen database type for this article")]),t._v(" "),a("li",[a("strong",[t._v("Understand why we need to use a MySql Docker image")]),t._v(" , we will also cover how to create a container from said image and what environment variables we need to set, for it to work")]),t._v(" "),a("li",[a("strong",[t._v("Learn how to connect to our MySql container")]),t._v(" , from our application container using linking, this is about realizing how to do basic linking between two containers and how this can be used to our advantage when defining the database startup configuration")]),t._v(" "),a("li",[a("strong",[t._v("Expand our knowledge on linking")]),t._v(" , by covering the new way to link containers, there are two ways of doing linking, one way is more preferred than the other, which is deprecated, so we will cover how the new way of doing things is done")]),t._v(" "),a("li",[a("strong",[t._v("Describe some good ways of managing our database")]),t._v(" , such as giving it an initial structure and seed it")])]),t._v(" "),a("h2",{attrs:{id:"resources"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#resources","aria-hidden":"true"}},[t._v("#")]),t._v(" Resources")]),t._v(" "),a("p",[t._v("Using Docker and containerization is about breaking apart a monolith into microservices. Throughout this series, we will learn to master Docker and all its commands. Sooner or later you will want to take your containers to a production environment. That environment is usually the Cloud. When you feel you've got enough Docker experience have a look at these links to see how Docker can be used in the Cloud as well:")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://docs.microsoft.com/en-gb/azure/containers/?wt.mc_id=devto-blog-chnoring",target:"_blank",rel:"noopener noreferrer"}},[t._v("Containers in the Cloud"),a("OutboundLink")],1),t._v("\nGreat overview page that shows what else there is to know about containers in the Cloud")]),t._v(" "),a("li",[a("a",{attrs:{href:"https://docs.microsoft.com/en-gb/azure/container-instances/container-instances-tutorial-prepare-app?wt.mc_id=devto-blog-chnoring",target:"_blank",rel:"noopener noreferrer"}},[t._v("Deploying your containers in the Cloud"),a("OutboundLink")],1),t._v(" Tutorial that shows how easy it is to leverage your existing Docker skill and get your services running in the Cloud")]),t._v(" "),a("li",[a("a",{attrs:{href:"https://docs.microsoft.com/en-gb/azure/container-instances/container-instances-tutorial-prepare-acr?wt.mc_id=devto-blog-chnoring",target:"_blank",rel:"noopener noreferrer"}},[t._v("Creating a container registry"),a("OutboundLink")],1),t._v("\nYour Docker images can be in Docker Hub but also in a Container Registry in the Cloud. Wouldn't it be great to store your images somewhere and actually be able to create a service from that Registry in a matter of minutes?")])]),t._v(" "),a("h2",{attrs:{id:"working-with-databases-in-general-and-mysql-in-particular"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#working-with-databases-in-general-and-mysql-in-particular","aria-hidden":"true"}},[t._v("#")]),t._v(" Working with databases in general and MySql in particular")]),t._v(" "),a("p",[t._v("With databases in general we want to be able to do the following:")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("read")]),t._v(" , we want to be able to read the data by using different kinds of queries")]),t._v(" "),a("li",[a("strong",[t._v("alter/create/delete")]),t._v(" , we need to be able to change the data")]),t._v(" "),a("li",[a("strong",[t._v("add structure")]),t._v(" , we need a way to create a structure like tables or collections so our data is saved in a specific format")]),t._v(" "),a("li",[a("strong",[t._v("add seed/initial data")]),t._v(" , in a simple database this might not be needed at all but in more complex scenario you would need some tables to be prepopulated with some basic data. Having a seed is also great to have under the development phase as it makes it easy to render certain view or test different scenarios if there is already pre existing data or that the data is put in a certain state, e.g a shopping cart has items and you want to test the checkout page.")])]),t._v(" "),a("p",[t._v("There are many more things we want to do to a database like adding indexes, adding users with different access rights and much much more but letâ€™s focus on these four points above as a references for what we, with the help of Docker should be able to support.")]),t._v(" "),a("h3",{attrs:{id:"installing-and-connecting-to-mysql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#installing-and-connecting-to-mysql","aria-hidden":"true"}},[t._v("#")]),t._v(" Installing and connecting to MySql")]),t._v(" "),a("p",[t._v("There are tons of ways to install MySql not all of them are fast ðŸ˜•. One of the easier ways on a Linux system is typing the following:")]),t._v(" "),a("blockquote",[a("p",[t._v("sudo apt-get install mysql-server")])]),t._v(" "),a("p",[t._v("On a Mac you would be using brew and then instead type:")]),t._v(" "),a("blockquote",[a("p",[t._v("brew install mysql")])]),t._v(" "),a("p",[t._v("In some other scenarios you are able to download an installer package and follow a wizard.")]),t._v(" "),a("p",[t._v("Once you are done installing MySql you will get some information similar to this, this will of course differ per installation package:")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1024/1*BxTYhoJ_clYeKZhWE44uJg.png",alt:""}})]),t._v(" "),a("p",[t._v("The above tells us we donâ€™t have a root password yet, YIKES. We can fix that though by running mysql-secure-installation . Letâ€™s for now just connect to the database running the suggested mysql -uroot .")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1024/1*E-dnIn17AStRYHGYmGdW6A.png",alt:""}})]),t._v(" "),a("p",[t._v("NOOO, what happened? We actually got this information in the larger image above, we needed to start MySql either by running brew services start mysql , which would run it as a background service or using mysql-server start which is more of a one off. Ok, letâ€™s enter brew services start :")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1024/1*hbnVt0MIAI5i8UDmdJaTtQ.png",alt:""}})]),t._v(" "),a("p",[t._v("The very last thing is it says Successfully started mysql :")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/466/1*-Zi5Ebc6BPSJlH8YvHbsgQ.gif",alt:""}})]),t._v(" "),a("p",[t._v("Letâ€™s see if Matthew is correct, can we connect ?")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1024/1*Hn3sSFf04Dxy6flp2B17YQ.png",alt:""}})]),t._v(" "),a("p",[t._v("And we get a prompt above "),a("code",[t._v("mysql>")]),t._v(", we are in ðŸ˜„")]),t._v(" "),a("p",[t._v("Ok so we managed to connect using NO password, we should fix that and we dont have any database created, we should fix that too ðŸ˜ƒ")]),t._v(" "),a("p",[t._v("Well itâ€™s not entirely true, we do have some databases, not just any databases with content created by yourself, but rather supportive ones that we shouldnâ€™t touch:")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/938/1*siqRgXGPjOotjMGfLkw7OQ.png",alt:""}})]),t._v(" "),a("p",[t._v("So next up would be to create and select the newly created database, so we can query from it:")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/772/1*fu4U70ZWwx8jkNQ2x90tVA.png",alt:""}})]),t._v(" "),a("p",[t._v("Ok, great, but wait, we donâ€™t have any tables? True true, we need to create those somehow. We could be creating them in the terminal but that would just be painful, lots and lots of multiline statements, so letâ€™s see if we can feed MySql a file with the database and all the tables we want in it. Letâ€™s first define a file that we can keep adding tables to:")]),t._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// database.sql")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// creates a table `tasks`")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("IF")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("EXISTS")]),t._v(" tasks "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\ntask_id "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AUTO_INCREMENT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\ntitle "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VARCHAR")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("255")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\nstart_date "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DATE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\ndue_date "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DATE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("status")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TINYINT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\npriority "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TINYINT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\ndescription "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TEXT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("task_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// add more tables below and indeces etc as our solution grows")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br")])]),a("p",[t._v("Ok then, we have a file with database structure, now for getting the content in there we can use the source command like so ( masking over the user name):")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1024/1*CQcfs7-Sn0_leH2FxFHZWw.png",alt:""}})]),t._v(" "),a("p",[t._v("If you want the full path to where your file is located just type PWD where your file is at and type source [path to sql file]/database.sql. As you can see above, we need to select a database before we run our SQL file so it targets a specific database and then we verify that the table has been created with SHOW TABLES; We can also use the same command to seed our database with data, we just give it a different file to process, one containing INSERT statements rather than CREATE TABLE...")]),t._v(" "),a("p",[t._v("Ok then. I think thatâ€™s enough MySql for now, letâ€™s talk MySql in the context of Docker next.")]),t._v(" "),a("h2",{attrs:{id:"why-we-need-a-mysql-docker-image-and-how-to-get-it-up-and-running-as-a-container"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#why-we-need-a-mysql-docker-image-and-how-to-get-it-up-and-running-as-a-container","aria-hidden":"true"}},[t._v("#")]),t._v(" Why we need a MySql Docker image and how to get it up and running as a container")]),t._v(" "),a("p",[t._v("Ok so letâ€™s now say we want a container for our application. Letâ€™s furthermore say that our solution needs a database. It wouldnâ€™t make much sense to install MySql on the host the computer is running on. I mean one of the mantras of containers is that we shouldnâ€™t have to care about the the host system the containers are running on. Ok so we need MySql in a container, but which container, the apps own container or a separate container? Thatâ€™s a good question depending on your situation, you could either install MySql with your app or run it in a separate container. Some argument for that is:")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("rolling updates")]),t._v(", your database can be kept online while your application nodes do individual restarts, you wonâ€™t experience downtime.")]),t._v(" "),a("li",[a("strong",[t._v("scalability")]),t._v(", you can add nodes to scale in a loosely coupled fashion")])]),t._v(" "),a("p",[t._v("There are a lot of arguments for and against and only you know exactly what works best for youâ€Šâ€”â€Šso you do you ðŸ˜ƒ")]),t._v(" "),a("h3",{attrs:{id:"mysql-as-stand-alone-image"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql-as-stand-alone-image","aria-hidden":"true"}},[t._v("#")]),t._v(" MySql as stand alone image")]),t._v(" "),a("p",[t._v("Letâ€™s talk about the scenario in which we pull down a MySql image. Ok, we will take this step by step so first thing we do is try to run it and as we learned from previous articles the image will be pulled down for us if we donâ€™t have it, so here is the command:")]),t._v(" "),a("blockquote",[a("p",[t._v("docker run --name=mysql-db mysql")])]),t._v(" "),a("p",[t._v("Ok, so whatâ€™s the output of that?")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1024/1*hrpOZwekpdv1yByOYQp4TQ.png",alt:""}})]),t._v(" "),a("p",[t._v("Pulling down the image, good, aaaand error.")]),t._v(" "),a("p",[t._v("We are doing all kinds of wrong ðŸ˜¦.")]),t._v(" "),a("p",[t._v("Database is uninitialized, password option is not specified and so on. Letâ€™s see if we can fix that:")]),t._v(" "),a("blockquote",[a("p",[t._v("docker run --name mysql-db -e MYSQL_ROOT_PASSWORD=complexpassword -d -p 8000:3306 mysql")])]),t._v(" "),a("p",[t._v("and the winner is:")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1024/1*KM2niK5vNNUfVDDSX9SCYA.png",alt:""}})]),t._v(" "),a("p",[t._v("Argh, our container we started before is up and running despite the error message it threw. Ok, letâ€™s bring down the container:")]),t._v(" "),a("blockquote",[a("p",[t._v("docker rm mysql-db")])]),t._v(" "),a("p",[t._v("and letâ€™s try to run it again with the database set like above:")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1024/1*YQIXSpKvsdR0NqYG3oNbqQ.png",alt:""}})]),t._v(" "),a("p",[t._v("Ok, we donâ€™t get a whole bunch of logging to the terminal, because we are running in Daemon mode so letâ€™s run docker ps to check:")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1024/1*hp8_3EcNM4oyUto2Gcgr6A.png",alt:""}})]),t._v(" "),a("p",[t._v("At this point we want to connect to it from the outside. Our port forwarding means we need to connect to it on 0.0.0.0:8001 :")]),t._v(" "),a("blockquote",[a("p",[t._v("mysql -uroot -pcomplexpassword -h 0.0.0.0 -P 8001")])]),t._v(" "),a("p",[t._v("Ok, just a comment above we can either specify the password or just write -p and we will be prompted for the password on the next row. Letâ€™s have a look at the result:")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1024/1*0dC2tjkdlD2byMFsYPj2Ug.png",alt:""}})]),t._v(" "),a("p",[t._v("Ok, we managed to connect to our database, it is reachable, great ðŸ˜ƒ.")]),t._v(" "),a("p",[t._v("But wait, can we reach a database, inside of container, from another container? Well here is where it gets tricky. This is where we need to link the two containers.")]),t._v(" "),a("h3",{attrs:{id:"connecting-to-database-from-node-js"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#connecting-to-database-from-node-js","aria-hidden":"true"}},[t._v("#")]),t._v(" Connecting to database from Node.js")]),t._v(" "),a("p",[t._v("Ok letâ€™s first add some code in our app that tries to connect to our database. First off we need to install the NPM package for mysql :")]),t._v(" "),a("blockquote",[a("p",[t._v("npm install mysql")])]),t._v(" "),a("p",[t._v("Then we add the following code to the top of our app.js file:")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// app.js")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" mysql "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mysql'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" con "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mysql"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createConnection")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\nhost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"localhost"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\nport"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8001")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\nuser"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"root"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\npassword"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"complexpassword"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\ndatabase"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Customers'")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\ncon"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("connect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("err")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Connected!"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br")])]),a("p",[t._v("So letâ€™s try this in the terminal:")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1024/1*JzE2uye8-GxIZyDNmf7izw.png",alt:""}})]),t._v(" "),a("p",[t._v("Pain and misery ðŸ˜¦")]),t._v(" "),a("p",[t._v("So why wonâ€™t it work.")]),t._v(" "),a("blockquote",[a("p",[t._v("This is because caching_sha2_password is introduced in MySQL 8.0, but the Node.js version is not implemented yet.")])]),t._v(" "),a("p",[t._v("Ok so what, we try Postgres or some other database? Well we can actually fix this by connecting to our container like so:")]),t._v(" "),a("blockquote",[a("p",[t._v("mysql -uroot -pcomplexpassword -h 0.0.0.0 -P 8001")])]),t._v(" "),a("p",[t._v("and once we are at the mysql prompt we can type the following:")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("mysql> ALTER USER 'root' IDENTIFIED WITH mysql_native_password BY 'complexpassword';\nmysql> FLUSH PRIVILEGES;\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("Letâ€™s try to run our node app.js command again and this time we get this:")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1024/1*d05U7bFAJlnKszKcxsTxRg.png",alt:""}})]),t._v(" "),a("p",[t._v("Finally!")]),t._v(" "),a("p",[t._v("Ok, so some call to this mysql_native_password seems to fix to whole thing. Letâ€™s go deeper into the rabbit hole, what is that?")]),t._v(" "),a("blockquote",[a("p",[t._v("MySQL includes a "),a("strong",[t._v("mysql_native_password")]),t._v(" plugin that implements native authentication; that is, authentication based on the password hashing method in use from before the introduction of pluggable authentication")])]),t._v(" "),a("p",[t._v("Ok, so that means MySql 8 have switched to some new pluggable authentication that our Node.js mysql library hasnâ€™t been able to catch up on. That means we can either pull down an earlier version of MySql or revert to native authentication, your call ðŸ˜ƒ")]),t._v(" "),a("h3",{attrs:{id:"linking"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#linking","aria-hidden":"true"}},[t._v("#")]),t._v(" Linking")]),t._v(" "),a("p",[t._v("The idea of linking is that a container shouldnâ€™t have to know any details on what IP or PORT the database, in this case, is running on. It should just assume that for example the app container and the database container can reach each other. A typical syntax looks like this:")]),t._v(" "),a("blockquote",[a("p",[t._v("docker run -d -p 5000:5000 --name product-service "),a("strong",[t._v("--link mypostgres:postgres")]),t._v(" chrisnoring/node")])]),t._v(" "),a("p",[t._v("Letâ€™s break the above down a bit:")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("app container")]),t._v(", we are creating an app container called product-service")]),t._v(" "),a("li",[t._v("--link we are calling this command to link our product-service container with the existing mypostgres container")]),t._v(" "),a("li",[a("strong",[t._v("link alias")]),t._v(", the statement --link mypostgres:postgres means that we specify what container to link with mypostgres and gives it an alias "),a("code",[t._v("postgres")]),t._v(". We will use this alias internally in "),a("code",[t._v("product-service")]),t._v(" container when we try to connect to our database")])]),t._v(" "),a("p",[t._v("Ok, so we think we kind of get the basics of linking, letâ€™s see how that applies to our existing my-container and how we can link it to our database container "),a("code",[t._v("mysql-db")]),t._v(". Well because we started my-container without linking it we need to tear it down and restart it with our --link command specified as an additional argument like so:")]),t._v(" "),a("blockquote",[a("p",[t._v("docker kill my-container && docker rm my-container")])]),t._v(" "),a("p",[t._v("That brings down the container. Before we bring it up though, we actually need to change some code, namely the part that has to do with connecting to our database. We are about to link it with our database container using the "),a("code",[t._v("--link mysql-db:mysql")]),t._v(" argument which means we no longer need the IP or the PORT reference so our connection code can now look like this:")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// part of app.js, the rest omitted for brevity")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" con "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mysql"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createConnection")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mysql"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("\n\nuser"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"root"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\npassword"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"complexpassword"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\ndatabase"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Customers'")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// and the rest of the code below")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br")])]),a("p",[t._v("The difference is now our host is no longer stating localhost and the port is not explicitly stating "),a("code",[t._v("8001")]),t._v(" cause the linking figures that out, all we need to focus on is knowing what alias we gave the database container when we linked e.g "),a("code",[t._v("mysql")]),t._v(". Because we both changed the code and we added another library myql we will need to rebuild the image, like so:")]),t._v(" "),a("blockquote",[a("p",[t._v("docker build - t chrisnoring/node .")])]),t._v(" "),a("p",[t._v("now letâ€™s get it started again, this time with a link:")]),t._v(" "),a("blockquote",[a("p",[t._v("docker run -d -p 8000:3000 --name my-container --link mysql-db:mysql chrisnoring/node")])]),t._v(" "),a("p",[t._v("and letâ€™s have a look at the output:")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1024/1*SxqwuggAPju3MpiJwy04sQ.png",alt:""}})]),t._v(" "),a("p",[t._v("We use the docker logs my-container to see the logs from our app container and the very last line says Connected! which comes from the callback function that tells us we successfully connected to MySql.")]),t._v(" "),a("p",[t._v("You know what time it is ? BOOOM!")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/500/1*PankPb9dXZglAwLMqW1y-Q.gif",alt:""}})]),t._v(" "),a("h2",{attrs:{id:"expand-our-knowledge-on-linking-â€”-there-is-another-way"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#expand-our-knowledge-on-linking-â€”-there-is-another-way","aria-hidden":"true"}},[t._v("#")]),t._v(" Expand our knowledge on linkingâ€Šâ€”â€Šthere is another way")]),t._v(" "),a("p",[t._v("Ok, so this is all well and good. We managed to place the application in one container and the database in another container. Butâ€¦ This linking we just looked at is considered legacy which means we need to learn another way of doing linking. Waitâ€¦ Itâ€™s not as bad as you think, it actually looks better syntactically.")]),t._v(" "),a("p",[t._v("This new way of doing this is called creating networks or custom bridge networks. Actually, thatâ€™s just one type of network we can create. The point is that they are dedicated groups that you can say that your container should belong to. A container can exist in multiple networks if it has cross cutting concerrns for more than one group. That all sounds great so show me some syntax right?")]),t._v(" "),a("p",[t._v("The first thing we need to do is to create the network we want the app container and database container to belong to. We create said network with the following command:")]),t._v(" "),a("blockquote",[a("p",[t._v("docker network create --driver bridge isolated_network")])]),t._v(" "),a("p",[t._v("Now that we have our network we just need to create each container with the newly created network as an additional argument. Letâ€™s start with the app container:")]),t._v(" "),a("blockquote",[a("p",[t._v("docker run -d -p 8000:3000 "),a("strong",[t._v("--net isolated_network")]),t._v(" --name my-container chrisnoring-node")])]),t._v(" "),a("p",[t._v("Above we are now using the --net syntax to create a network that we call isolated_network and the rest is just the usual syntax we use to create and run our container. That was easy ðŸ˜ƒ")]),t._v(" "),a("p",[t._v("What about the database container?")]),t._v(" "),a("blockquote",[a("p",[t._v("docker run -p 8000:3306 "),a("strong",[t._v("--net isolated_network")]),t._v(" --name mysql-db -e MYSQL_ROOT_PASSWORD=complexpassword -d mysql")])]),t._v(" "),a("p",[t._v("As you can see above we just create and run our database container but with the added --net isolated_network .")]),t._v(" "),a("p",[t._v("Looking back at this way of doing it, we no longer need to explicitly say that one container needs to be actively linked to another, we only place a container in a specific network and the containers in that network knows how to talk to each other.")]),t._v(" "),a("p",[t._v("There is a lot more to learn about networks, there are different types and a whole host of commands. I do think we got the gist of it, e.g how it differs from legacy linking. Have a look at this link to learn more "),a("a",{attrs:{href:"https://docs.docker.com/network/links/",target:"_blank",rel:"noopener noreferrer"}},[t._v("docs on networking"),a("OutboundLink")],1)]),t._v(" "),a("h2",{attrs:{id:"general-database-management-in-a-container-setting"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#general-database-management-in-a-container-setting","aria-hidden":"true"}},[t._v("#")]),t._v(" General database management in a container setting")]),t._v(" "),a("p",[t._v("Ok, so we talked at the beginning of this section how we can create the database structure as a file and how we even can create our seed data as a file and how we can run those once we are at the MySql prompt after we connected to it. Here is the thing. How we get that structure and seed data in there is a little bit up to you but I will try to convey some general guidelines and ideas:")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("structure")]),t._v(", you want to run this file at some point. To get in into the database you can either connect using the "),a("code",[t._v("mysql")]),t._v(" client and refer to the file being outside in the host computer. Or you can place this file as part of your app repo and just let the Dockerfile copy the file into the container and then run it. Another way is looking at libraries such as Knex or Sequelize that supports migrations and specify the database structure in migrations that are being run. This is a bit different topic all together but I just wanted to show that there are different ways for you to handle this")]),t._v(" "),a("li",[a("strong",[t._v("seed")]),t._v(", you can treat the seed the same way as you do the structure. This is something that needs to happen after we get our structure in and it is a one-off. Itâ€™s not something you want to happen at every start of the app or the database and depending on whether the seed is just some basic structural data or some data you need for testing purposes you most likely want to do this manually, e.g you connect to "),a("code",[t._v("mysql")]),t._v(" using the client and actively runs the source command")])]),t._v(" "),a("h2",{attrs:{id:"summary"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#summary","aria-hidden":"true"}},[t._v("#")]),t._v(" Summary")]),t._v(" "),a("p",[t._v("Ok, this article managed to cover some general information on MySql and discussed how we could get some structural things in there like tables and we also talked about an initial/test seed and how to get it into the database using standalone files.")]),t._v(" "),a("p",[t._v("Then we discussed why we should run databases in Docker container rather than installed on the host and went on to show how we could get two containers to talk to each other using a legacy linking technique. We did also spend some time cursing at MySql 8 and the fact the "),a("code",[t._v("mysql")]),t._v(" Node.js module is not in sync which forced us to fix it.")]),t._v(" "),a("p",[t._v("Once we covered the legacy linking bit we couldnâ€™t really stop there but we needed to talk about the new way we link containers, namely using networks.")]),t._v(" "),a("p",[t._v("Lastly we shared some general guidelines on database management and hopefully, you are now at a point where you understand how we can add databases to our app and keep developing the app.")]),t._v(" "),a("p",[t._v("Follow me on "),a("a",{attrs:{href:"https://twitter.com/chris_noring",target:"_blank",rel:"noopener noreferrer"}},[t._v("Twitter"),a("OutboundLink")],1),t._v(", happy to take your suggestions on topics or improvements /Chris")])])},[],!1,null,null,null);e.default=s.exports}}]);