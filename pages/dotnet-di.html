<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>How YOU can Learn Dependency Injection in .NET Core and C#</title>
    <meta name="description" content="[object Object]">
    
    
    <link rel="preload" href="/assets/css/0.styles.b244743b.css" as="style"><link rel="preload" href="/assets/js/app.1077fdd6.js" as="script"><link rel="preload" href="/assets/js/7.1b275639.js" as="script"><link rel="preload" href="/assets/js/6.6ae5d1ce.js" as="script"><link rel="preload" href="/assets/js/31.c890fac6.js" as="script"><link rel="prefetch" href="/assets/js/1.1b576644.js"><link rel="prefetch" href="/assets/js/10.7bac90a4.js"><link rel="prefetch" href="/assets/js/11.01a6b72e.js"><link rel="prefetch" href="/assets/js/12.004aabb2.js"><link rel="prefetch" href="/assets/js/13.ce52cddb.js"><link rel="prefetch" href="/assets/js/14.b6e0c6b9.js"><link rel="prefetch" href="/assets/js/15.07067913.js"><link rel="prefetch" href="/assets/js/16.50314d1a.js"><link rel="prefetch" href="/assets/js/17.7ce6a9cd.js"><link rel="prefetch" href="/assets/js/18.eda17916.js"><link rel="prefetch" href="/assets/js/19.cd61a8a6.js"><link rel="prefetch" href="/assets/js/20.a4d63b29.js"><link rel="prefetch" href="/assets/js/21.8ccc4b4a.js"><link rel="prefetch" href="/assets/js/22.5e93f2ba.js"><link rel="prefetch" href="/assets/js/23.dfa71c99.js"><link rel="prefetch" href="/assets/js/24.b508333a.js"><link rel="prefetch" href="/assets/js/25.3e09c98a.js"><link rel="prefetch" href="/assets/js/26.5d960c66.js"><link rel="prefetch" href="/assets/js/27.9a5480bd.js"><link rel="prefetch" href="/assets/js/28.7bbac0cf.js"><link rel="prefetch" href="/assets/js/29.98080ec7.js"><link rel="prefetch" href="/assets/js/3.262e56e6.js"><link rel="prefetch" href="/assets/js/30.40bf3c4e.js"><link rel="prefetch" href="/assets/js/32.c7f0736b.js"><link rel="prefetch" href="/assets/js/33.6ca47a2f.js"><link rel="prefetch" href="/assets/js/34.7a1dc0cf.js"><link rel="prefetch" href="/assets/js/35.6cf65d37.js"><link rel="prefetch" href="/assets/js/36.695fee10.js"><link rel="prefetch" href="/assets/js/37.31210639.js"><link rel="prefetch" href="/assets/js/38.047f8b64.js"><link rel="prefetch" href="/assets/js/39.6552e1ac.js"><link rel="prefetch" href="/assets/js/4.56ae630c.js"><link rel="prefetch" href="/assets/js/40.3699c732.js"><link rel="prefetch" href="/assets/js/41.2d165e9d.js"><link rel="prefetch" href="/assets/js/42.b3f5dc5b.js"><link rel="prefetch" href="/assets/js/43.a9f2029b.js"><link rel="prefetch" href="/assets/js/44.da684f41.js"><link rel="prefetch" href="/assets/js/45.8f727a31.js"><link rel="prefetch" href="/assets/js/46.ba246365.js"><link rel="prefetch" href="/assets/js/47.0a9a1060.js"><link rel="prefetch" href="/assets/js/48.f3983d5c.js"><link rel="prefetch" href="/assets/js/49.9aaf4a92.js"><link rel="prefetch" href="/assets/js/5.373600b1.js"><link rel="prefetch" href="/assets/js/50.ee242d5e.js"><link rel="prefetch" href="/assets/js/51.70b601ff.js"><link rel="prefetch" href="/assets/js/52.c3a923fb.js"><link rel="prefetch" href="/assets/js/53.7912b855.js"><link rel="prefetch" href="/assets/js/54.1d98eb4a.js"><link rel="prefetch" href="/assets/js/55.af78a3a1.js"><link rel="prefetch" href="/assets/js/56.019c6498.js"><link rel="prefetch" href="/assets/js/57.efbda61a.js"><link rel="prefetch" href="/assets/js/58.9bcc2893.js"><link rel="prefetch" href="/assets/js/59.2bf33e43.js"><link rel="prefetch" href="/assets/js/60.0a77889c.js"><link rel="prefetch" href="/assets/js/61.3717cfbc.js"><link rel="prefetch" href="/assets/js/62.df5410c6.js"><link rel="prefetch" href="/assets/js/63.cf37fa68.js"><link rel="prefetch" href="/assets/js/64.608fde42.js"><link rel="prefetch" href="/assets/js/65.b497f5f9.js"><link rel="prefetch" href="/assets/js/66.74cfc266.js"><link rel="prefetch" href="/assets/js/67.ab455053.js"><link rel="prefetch" href="/assets/js/68.c76ed714.js"><link rel="prefetch" href="/assets/js/69.2d7ac801.js"><link rel="prefetch" href="/assets/js/70.371523a9.js"><link rel="prefetch" href="/assets/js/71.d17d186a.js"><link rel="prefetch" href="/assets/js/8.a354cea0.js"><link rel="prefetch" href="/assets/js/9.be23d1a2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b244743b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/author/" class="nav-link">Author</a></div><div class="nav-item"><a href="/articles/" class="nav-link">Blog</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/author/" class="nav-link">Author</a></div><div class="nav-item"><a href="/articles/" class="nav-link">Blog</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>How YOU can Learn Dependency Injection in .NET Core and C#</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/dotnet-di.html#what-is-dependency-injection" class="sidebar-link">What is Dependency Injection</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/dotnet-di.html#references" class="sidebar-link">References</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/dotnet-di.html#why-use-it" class="sidebar-link">Why use it</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/dotnet-di.html#di-in-net-core-it-s-built-in" class="sidebar-link">DI in .NET Core - it's built-in</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/dotnet-di.html#what-to-register" class="sidebar-link">What to register</a></li><li class="sidebar-sub-header"><a href="/pages/dotnet-di.html#dependency-graph" class="sidebar-link">Dependency Graph</a></li></ul></li><li><a href="/pages/dotnet-di.html#demo-registering-a-service" class="sidebar-link">DEMO - registering a Service</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/dotnet-di.html#create-a-solution" class="sidebar-link">Create a solution</a></li><li class="sidebar-sub-header"><a href="/pages/dotnet-di.html#create-a-webapi-project" class="sidebar-link">Create a WebApi project</a></li><li class="sidebar-sub-header"><a href="/pages/dotnet-di.html#fail" class="sidebar-link">fail</a></li><li class="sidebar-sub-header"><a href="/pages/dotnet-di.html#registering-a-service" class="sidebar-link">Registering a service</a></li></ul></li><li><a href="/pages/dotnet-di.html#service-lifetimes" class="sidebar-link">Service lifetimes</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/dotnet-di.html#transient" class="sidebar-link">Transient</a></li><li class="sidebar-sub-header"><a href="/pages/dotnet-di.html#singleton" class="sidebar-link">Singleton</a></li><li class="sidebar-sub-header"><a href="/pages/dotnet-di.html#scoped" class="sidebar-link">Scoped</a></li><li class="sidebar-sub-header"><a href="/pages/dotnet-di.html#here-be-dragons" class="sidebar-link">Here be dragons</a></li></ul></li><li><a href="/pages/dotnet-di.html#summary" class="sidebar-link">Summary</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="how-you-can-learn-dependency-injection-in-net-core-and-c"><a href="#how-you-can-learn-dependency-injection-in-net-core-and-c" aria-hidden="true" class="header-anchor">#</a> How YOU can Learn Dependency Injection in .NET Core and C#</h1> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/69mlfxzpei2p9ggc0xls.jpg" alt=""></p> <p>Follow me on <a href="https://twitter.com/chris_noring" target="_blank" rel="noopener noreferrer">Twitter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, happy to take your suggestions on topics or improvements /Chris</p> <p>This is an intro to Dependency Injection, also called DI. I plan a follow-up post covering more advanced scenarios. For now, I want to explain what it is and how you can use it and finally show how it helps to test A LOT.</p> <h2 id="what-is-dependency-injection"><a href="#what-is-dependency-injection" aria-hidden="true" class="header-anchor">#</a> What is Dependency Injection</h2> <p>It's a programming technique that makes a class independent of its dependencies.</p> <blockquote><p>English?</p></blockquote> <p>We don't rely on a concrete implementation of our dependencies, but rather interfaces. This makes our code more flexible and we can easily switch out a concrete implementation for another while maintaining the same logic.</p> <h2 id="references"><a href="#references" aria-hidden="true" class="header-anchor">#</a> References</h2> <ul><li><a href="https://docs.microsoft.com/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-3.0&amp;wt.mc_id=devto-blog-chnoring" target="_blank" rel="noopener noreferrer">Overview of Dependency Injection<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.microsoft.com/aspnet/core/mvc/views/dependency-injection?view=aspnetcore-3.0&amp;wt.mc_id=devto-blog-chnoring" target="_blank" rel="noopener noreferrer">DI MVC example<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.microsoft.com/aspnet/core/mvc/controllers/dependency-injection?view=aspnetcore-3.0&amp;wt.mc_id=devto-blog-chnoring" target="_blank" rel="noopener noreferrer">DI in Controllers<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.martinfowler.com/articles/injection.html" target="_blank" rel="noopener noreferrer">Dependency Injection pattern by Martin Fowler<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjectionview=dotnet-plat-ext-3.0&amp;wt.mc_id=devto-blog-chnoring" target="_blank" rel="noopener noreferrer">Overview of Dependency Injection namespace<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="why-use-it"><a href="#why-use-it" aria-hidden="true" class="header-anchor">#</a> Why use it</h2> <p>There are many advantages:</p> <ul><li><strong>Flexible code</strong>, we can switch out one implementation for another without changing the business logic.</li> <li><strong>Easy to test</strong>, because we rely on interfaces over implementations - we can more easily test our code without worrying about side-effects. We will show this later in the article.</li></ul> <h2 id="di-in-net-core-it-s-built-in"><a href="#di-in-net-core-it-s-built-in" aria-hidden="true" class="header-anchor">#</a> DI in .NET Core - it's built-in</h2> <p>There's a built-in Dependency Injection container that's used by a lot of internal services like:</p> <ul><li>Hosting Environment</li> <li>Configuration</li> <li>Routing</li> <li>MVC</li> <li>ApplicationLifetime</li> <li>Logging</li></ul> <p>The container is sometimes referred to as IoC, <strong>I</strong>nversion of <strong>C</strong>ontrol <strong>C</strong>ontainer.</p> <p>The overall idea is to <em>Register</em> at the application startup and then <em>Resolve</em> at runtime when needed.</p> <p>Container responsibilities:</p> <ul><li>Creating</li> <li>Disposing</li></ul> <p>Key concepts:</p> <ul><li><strong>IServiceCollection</strong>, Register services, lets the IoC container know of concrete implementation. It should be used to resolve what Interface belongs to what implementation. How something is created can be as simple as just instantiating an object but sometimes we need more data than that.</li> <li><strong>IServiceProvider</strong>, Resolve service instances, actually looking up what interface belongs to what concrete implementation and carry out the creation.</li></ul> <p>It lives in the <code>Microsoft.Extensions.DependencyInjection</code> namespace. All the classes and code related to DI can be found there.</p> <h3 id="what-to-register"><a href="#what-to-register" aria-hidden="true" class="header-anchor">#</a> What to register</h3> <p>There are some telltale signs.</p> <ul><li><strong>Lifespan outside of this method?</strong>, Are we <em>new-ing</em> the service, any services our can they live within the scope of the method? I.e are they a dependency or not?</li> <li><strong>More than one version</strong>, Can there be more than one version of this service?</li> <li><strong>Testability</strong>, ideally you only want to test a specific method. If you got code that does a lot of other things in your method, you probably want to move that to a dedicated service. This moved code would then become dependencies to the method in question</li> <li><strong>Side-effect</strong>, This is similar to the point above but it stresses the importance of having a method that does only one thing. If a side-effect is produced, i.e accessing a network resource, doing an HTTP call or interacting with I/O - then it should be placed in a separate service and be injected in as a dependency.</li></ul> <p>Essentially, you will end up moving out code to dedicated services and then inject these services as dependencies via a constructor. You might start out with code looking like so:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Action</span><span class="token punctuation">(</span><span class="token keyword">double</span> amount<span class="token punctuation">,</span> <span class="token keyword">string</span> cardNumber<span class="token punctuation">,</span> <span class="token keyword">string</span> address<span class="token punctuation">,</span> <span class="token keyword">string</span> city<span class="token punctuation">,</span> <span class="token keyword">string</span> name<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
  <span class="token keyword">var</span> paymentService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PaymentService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> successfullyCharged <span class="token operator">=</span> paymentService<span class="token punctuation">.</span><span class="token function">Charge</span><span class="token punctuation">(</span><span class="token keyword">int</span> amount<span class="token punctuation">,</span> cardNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>successfullyCharged<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span>
    <span class="token keyword">var</span> shippingService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShippingService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shippingService<span class="token punctuation">.</span><span class="token function">Ship</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> city<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>The above has many problems:</p> <ul><li><strong>Unwanted side-effects when testing</strong>, The first problem is that we control the lifetime of <code>PaymentService</code> and <code>ShippingService</code>, thus risking firing off a side-effect, an HTTP call, when trying to test.</li> <li><strong>Can't test all paths</strong>, we can't really test all paths, we can't ask the PaymentService to respond differently so we can test all execution paths</li> <li><strong>Hard to extend</strong>, will this PaymentService cover all the possible means of payment or would we need to add a lot of conditional code in this method to cover different ways of taking payment if we added say support for <em>PayPal</em> or a new type of card, etc?</li> <li><strong>Unvalidated Primitives</strong>, there are primitives like <code>double</code> and <code>string</code>. Can we trust those values, is the <code>address</code> a valid address for example?</li></ul> <p>From the above, we realize that we need to refactor our code into something more maintainable and more secure. Turning a lot of the code into dependencies and replacing primitives with more complex constructs, is a good way to go.</p> <p>The result could look something like this:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">class</span> <span class="token class-name">Controller</span> 
  <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IPaymentService</span> _paymentService<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IShippingService</span> _shippingService<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Controller</span><span class="token punctuation">(</span>
    <span class="token class-name">IPaymentService</span> paymentService<span class="token punctuation">,</span>
    <span class="token class-name">IShippingService</span> shippingService
    <span class="token punctuation">)</span> 
  <span class="token punctuation">{</span>
    _paymentService <span class="token operator">=</span> paymentService<span class="token punctuation">;</span>
    _shippingService <span class="token operator">=</span> shippingService<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Action</span><span class="token punctuation">(</span><span class="token class-name">IPaymentInfo</span> paymentInfo<span class="token punctuation">,</span> <span class="token class-name">IShippingAddress</span> shippingAddress<span class="token punctuation">)</span> 
  <span class="token punctuation">{</span>
    <span class="token keyword">var</span> successfullyCharged <span class="token operator">=</span> _paymentService<span class="token punctuation">.</span><span class="token function">Charge</span><span class="token punctuation">(</span>paymentInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>successfullyCharged<span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
      _shippingService<span class="token punctuation">.</span><span class="token function">Ship</span><span class="token punctuation">(</span>ShippingAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>Above we have turned both the <code>PaymentService</code> and <code>ShippingService</code> into dependencies that we inject in the constructor. We also see that all the primitives have been collected into the complex structures <code>IShippingAddress</code> and <code>IPaymentInfo</code>.</p> <h3 id="dependency-graph"><a href="#dependency-graph" aria-hidden="true" class="header-anchor">#</a> Dependency Graph</h3> <p>When you have a dependency it might itself rely on another dependency being resolved first and so on and so forth. This means we get a hierarchy of dependencies that need to be resolved in the right order for things to work out. We call this a <em>Dependency Graph</em>.</p> <h2 id="demo-registering-a-service"><a href="#demo-registering-a-service" aria-hidden="true" class="header-anchor">#</a> DEMO - registering a Service</h2> <p>We will do the following:</p> <ul><li><strong>create</strong> a .NET Core solution</li> <li><strong>add</strong> a webapi project to our solution</li> <li><strong>fail</strong>, see what happens if we forgot to register a service. It's important to recognize the error message so we know where we went wrong and can fix it</li> <li><strong>registering a service</strong>, we will register our service and we will now see how everything works</li></ul> <h3 id="create-a-solution"><a href="#create-a-solution" aria-hidden="true" class="header-anchor">#</a> Create a solution</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>mkdir di-demo
cd di-demo

dotnet new sln
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>this will create the following structure:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>-| di-demo
---| di-demo.sln
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="create-a-webapi-project"><a href="#create-a-webapi-project" aria-hidden="true" class="header-anchor">#</a> Create a WebApi project</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>dotnet new webapi -o api
dotnet sln add api/api.csproj
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>The above will create a <code>webapi</code> project and add it to our solution file.</p> <p>Now we have the following structure:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>-| di-demo
---| di-demo.sln
---| api/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="fail"><a href="#fail" aria-hidden="true" class="header-anchor">#</a> fail</h3> <p>First, we will compile and run our project so we type:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>dotnet run
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>First time you run the project the web browser might tell you something like <em>your connection is not secure</em>. You have a dev cert that's not trusted. Fortunately, there's a built-in tool that can fix this so you can run a command like this:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>dotnet dev-certs https --trust
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>For more context on the problem:</p> <blockquote><p>https://www.hanselman.com/blog/DevelopingLocallyWithASPNETCoreUnderHTTPSSSLAndSelfSignedCerts.aspx</p></blockquote> <p>You should have something like this running:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/tqejf0xhgfhuf35vo1eh.png" alt=""></p> <p>Ok then, we don't have an error but let's introduce one.</p> <p>Let's do the following:</p> <ol><li><strong>Create a controller</strong> that supports getting products, this should inject a <code>ProductsService</code></li> <li><strong>Create a ProductsService</strong>, this should be able to retrieve Products from a data source</li> <li>**Create a IProductsService interface, inject this interface in the controller</li></ol> <p><strong>Add a ProductsController</strong></p> <p>Add the file <code>ProductsController.cs</code> with the following content:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> System<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Linq<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks<span class="token punctuation">;</span>
<span class="token keyword">using</span> Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Mvc<span class="token punctuation">;</span>
<span class="token keyword">using</span> Services<span class="token punctuation">;</span>

<span class="token keyword">namespace</span> api<span class="token punctuation">.</span>Controllers
<span class="token punctuation">{</span>
  <span class="token punctuation">[</span><span class="token class-name">ApiController</span><span class="token punctuation">]</span>
  <span class="token punctuation">[</span><span class="token class-name">Route</span><span class="token punctuation">(</span><span class="token string">&quot;[controller]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductsController</span> <span class="token punctuation">:</span> <span class="token class-name">ControllerBase</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IProductsService</span> _productsService<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token function">ProductsController</span><span class="token punctuation">(</span><span class="token class-name">IProductsService</span> productsService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _productsService <span class="token operator">=</span> productsService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token class-name">HttpGet</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span>Product<span class="token operator">&gt;</span> <span class="token function">GetProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
      <span class="token keyword">return</span> _productsService<span class="token punctuation">.</span><span class="token function">GetProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>Note how we <em>inject</em> the <code>IProductsService</code> in the constructor. This file should be added to the <code>Controllers</code> directory.</p> <p><strong>Add a ProductsService</strong></p> <p>Let's create a file <code>ProductsService.cs</code> under a directory <code>Services</code>, with the following content:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> System<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Linq<span class="token punctuation">;</span>

<span class="token keyword">namespace</span> Services <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Title <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductsService</span><span class="token punctuation">:</span> <span class="token class-name">IProductsService</span> 
  <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> List<span class="token operator">&lt;</span>Product<span class="token operator">&gt;</span> Products <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>Product<span class="token operator">&gt;</span> 
    <span class="token punctuation">{</span> 
      <span class="token keyword">new</span> <span class="token class-name">Product</span> <span class="token punctuation">{</span> Title<span class="token operator">=</span> <span class="token string">&quot;DVD player&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Product</span> <span class="token punctuation">{</span> Title<span class="token operator">=</span> <span class="token string">&quot;TV&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Product</span> <span class="token punctuation">{</span> Title<span class="token operator">=</span> <span class="token string">&quot;Projector&quot;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span>Product<span class="token operator">&gt;</span> <span class="token function">GetProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Products<span class="token punctuation">.</span><span class="token function">AsEnumerable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><strong>Create an interface IProductsController</strong></p> <p>Let's create the file <code>IProductsController.cs</code> under the <code>Services</code> directory, with the following content:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> System<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic<span class="token punctuation">;</span>

<span class="token keyword">namespace</span> Services 
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IProductsService</span>
  <span class="token punctuation">{</span>
      IEnumerable<span class="token operator">&lt;</span>Product<span class="token operator">&gt;</span> <span class="token function">GetProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>Run</strong></p> <p>Let's run the project with:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>dotnet build
dotnet run
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>We should get the following response in the browser:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/p5163j4fxgq8qq6o6by6.png" alt=""></p> <p>It's failing, just like we planned. Now what?</p> <p>Well, we fix it, by registering it with our container.</p> <h3 id="registering-a-service"><a href="#registering-a-service" aria-hidden="true" class="header-anchor">#</a> Registering a service</h3> <p>Ok, let's fix our problem. We do so by opening up the file <code>Startup.cs</code> in the project root. Let's find the <code>ConfigureServices()</code> method. It should have the following implementation currently:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Let's change the code to the following:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddTransient</span><span class="token punctuation">&lt;</span><span class="token class-name">IProductsService</span><span class="token punctuation">,</span> <span class="token class-name">ProductsService</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>The call to <code>services.AddTransient()</code> registers <code>IProductsService</code> and associates it with the implementing class <code>ProductsService</code>. If we run our code again:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>dotnet run
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Now your browser should be happy and look like this:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/tobp1d7nis6v2yfwdbkz.png" alt=""></p> <blockquote><p>Do we know all we need to know now?</p></blockquote> <p>No, there's lots more to know. So please read on in the next section to find out about different lifetimes, <em>transient</em> is but one type of lifetime type.</p> <h2 id="service-lifetimes"><a href="#service-lifetimes" aria-hidden="true" class="header-anchor">#</a> Service lifetimes</h2> <p>The service life time means how long the service will live, before it's being garbage collected. There are currently three different lifetimes:</p> <ul><li><strong>Transient</strong>, <code>services.AddTransient()</code>, the service is created each time it is requested</li> <li><strong>Singleton</strong>, <code>services.AddSingleton()</code>, created once for the lifetime of the application</li> <li><strong>Scoped</strong>, <code>services.AddScoped()</code>, created once per request</li></ul> <blockquote><p>So when to use each kind?</p></blockquote> <p>Good question.</p> <h3 id="transient"><a href="#transient" aria-hidden="true" class="header-anchor">#</a> Transient</h3> <p>So for Transient, it makes sense to use when you have a mutable state and it's important that the service consumer gets their own copy of this service. Also when thread-safety is not a requirement. This is a good <em>default</em> choice when you don't know what life time to go with.</p> <h3 id="singleton"><a href="#singleton" aria-hidden="true" class="header-anchor">#</a> Singleton</h3> <p>Singleton means that we have one instance for the lifetime of the application. This is good if we want to share state or creating the Service is considered expensive and we want to create it only once. So this can boost performance as it's only created once and garbage collected once. Because it can be accessed by many consumers thread-safety is a thing that needs to be considered. A good use case here is a memory cache but ensure you are making it thread-safe. Read more here about how to make something <em>thread-safe</em>:</p> <blockquote><p>http://www.albahari.com/threading/part2.aspx</p></blockquote> <p>Read especially about the <code>lock</code> keyword in the above link.</p> <h3 id="scoped"><a href="#scoped" aria-hidden="true" class="header-anchor">#</a> Scoped</h3> <p>Scoped means it's created once per request. So all calling consumers within that request will get the same instance. Examples of scoped services are for example <code>DbContext</code> for Entity Framework. It's the class we use to access a Database. It makes sense to make it <em>scoped</em>. We are likely to do more than one call to it during our request and the resource should be scoped to that specific request/user.</p> <h3 id="here-be-dragons"><a href="#here-be-dragons" aria-hidden="true" class="header-anchor">#</a> Here be dragons</h3> <p>There's such a thing as <em>captured dependencies</em>. This means that a service lives longer than expected.</p> <blockquote><p>So why is that bad?</p></blockquote> <p>Well, you want services to live according to their lifetime, otherwise, we take up unnecessary space in memory.</p> <blockquote><p>How does it happen?</p></blockquote> <p>When you start depending on a Service with a shorter lifetime than yourself you are effectively <em>capturing</em> it, forcing it to stay around according to your lifetime. Example:</p> <p>You register a <code>ProductsService</code> with a scoped lifetime and an <code>ILogService</code> with a transient lifetime. Then you inject the <code>ILogService</code> into the <code>ProductsService</code> constructor and thereby <em>capturing</em> it.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>class ProductsService 
{
  ProductsService(ILogService logService) 
  {

  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>Don't do that!</p></blockquote> <p>If you are going to depend on something ensure that what you inject has an equal or longer life time than yourself. So either change what you depend on or change the lifetime of your dependency.</p> <h2 id="summary"><a href="#summary" aria-hidden="true" class="header-anchor">#</a> Summary</h2> <p>We have explained what Dependency Injection is and why it's a good idea to use it. Additionally, we have shown how the built-in container helps us register our dependencies. Lastly, we've discussed how there are different lifetimes for a dependency and which one we should be choosing.</p> <p>This was the first part of the built-in container. I hope you are excited about a follow-up post talking about some of its more advanced features.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1077fdd6.js" defer></script><script src="/assets/js/7.1b275639.js" defer></script><script src="/assets/js/6.6ae5d1ce.js" defer></script><script src="/assets/js/31.c890fac6.js" defer></script>
  </body>
</html>
