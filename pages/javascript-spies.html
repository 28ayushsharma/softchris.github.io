<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Reverse Engineering - understanding Spies in Testing</title>
    <meta name="description" content="[object Object]">
    
    
    <link rel="preload" href="/assets/css/0.styles.7ec4ed58.css" as="style"><link rel="preload" href="/assets/js/app.47a3764b.js" as="script"><link rel="preload" href="/assets/js/5.218403d0.js" as="script"><link rel="preload" href="/assets/js/4.5f5dd8b1.js" as="script"><link rel="preload" href="/assets/js/44.95f423de.js" as="script"><link rel="prefetch" href="/assets/js/1.87395e1a.js"><link rel="prefetch" href="/assets/js/10.2588e758.js"><link rel="prefetch" href="/assets/js/11.48005f74.js"><link rel="prefetch" href="/assets/js/12.14bec62a.js"><link rel="prefetch" href="/assets/js/13.d1becdba.js"><link rel="prefetch" href="/assets/js/14.06fa3738.js"><link rel="prefetch" href="/assets/js/15.ea5c075f.js"><link rel="prefetch" href="/assets/js/16.30f674e7.js"><link rel="prefetch" href="/assets/js/17.c350d3df.js"><link rel="prefetch" href="/assets/js/18.0ea86f84.js"><link rel="prefetch" href="/assets/js/19.15dc21da.js"><link rel="prefetch" href="/assets/js/20.fcf52a6d.js"><link rel="prefetch" href="/assets/js/21.4d67b731.js"><link rel="prefetch" href="/assets/js/22.84ab1f55.js"><link rel="prefetch" href="/assets/js/23.4b863e68.js"><link rel="prefetch" href="/assets/js/24.a0c2b0e5.js"><link rel="prefetch" href="/assets/js/25.4cd17513.js"><link rel="prefetch" href="/assets/js/26.14977655.js"><link rel="prefetch" href="/assets/js/27.e814e1b0.js"><link rel="prefetch" href="/assets/js/28.ca28b489.js"><link rel="prefetch" href="/assets/js/29.418db958.js"><link rel="prefetch" href="/assets/js/3.36824ab9.js"><link rel="prefetch" href="/assets/js/30.2ec8b299.js"><link rel="prefetch" href="/assets/js/31.816e9374.js"><link rel="prefetch" href="/assets/js/32.5d4bbdd9.js"><link rel="prefetch" href="/assets/js/33.52f52188.js"><link rel="prefetch" href="/assets/js/34.b5a43178.js"><link rel="prefetch" href="/assets/js/35.1027469b.js"><link rel="prefetch" href="/assets/js/36.2e4ea452.js"><link rel="prefetch" href="/assets/js/37.62209761.js"><link rel="prefetch" href="/assets/js/38.e9fbb2e1.js"><link rel="prefetch" href="/assets/js/39.10d55c14.js"><link rel="prefetch" href="/assets/js/40.895ca19c.js"><link rel="prefetch" href="/assets/js/41.b412e047.js"><link rel="prefetch" href="/assets/js/42.80405299.js"><link rel="prefetch" href="/assets/js/43.acdb92bb.js"><link rel="prefetch" href="/assets/js/45.40305b7e.js"><link rel="prefetch" href="/assets/js/46.a73d0d64.js"><link rel="prefetch" href="/assets/js/47.8f879218.js"><link rel="prefetch" href="/assets/js/48.bcfb1069.js"><link rel="prefetch" href="/assets/js/49.3b222466.js"><link rel="prefetch" href="/assets/js/50.43b7a9ee.js"><link rel="prefetch" href="/assets/js/51.dbcc93e8.js"><link rel="prefetch" href="/assets/js/52.a4e02baf.js"><link rel="prefetch" href="/assets/js/53.82cb2687.js"><link rel="prefetch" href="/assets/js/54.2008719d.js"><link rel="prefetch" href="/assets/js/55.cf4425aa.js"><link rel="prefetch" href="/assets/js/56.d0399703.js"><link rel="prefetch" href="/assets/js/57.0ef6c637.js"><link rel="prefetch" href="/assets/js/58.ca8f7c47.js"><link rel="prefetch" href="/assets/js/59.706bc835.js"><link rel="prefetch" href="/assets/js/6.3283c200.js"><link rel="prefetch" href="/assets/js/60.b74976da.js"><link rel="prefetch" href="/assets/js/61.bf9aac0f.js"><link rel="prefetch" href="/assets/js/62.f47a75cb.js"><link rel="prefetch" href="/assets/js/63.56d02f0a.js"><link rel="prefetch" href="/assets/js/64.45eb43e1.js"><link rel="prefetch" href="/assets/js/65.b9d5ba2a.js"><link rel="prefetch" href="/assets/js/7.705f4e5d.js"><link rel="prefetch" href="/assets/js/8.f3baf431.js"><link rel="prefetch" href="/assets/js/9.eb210b13.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7ec4ed58.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/author/" class="nav-link">Author</a></div><div class="nav-item"><a href="/articles/" class="nav-link">Blog</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/author/" class="nav-link">Author</a></div><div class="nav-item"><a href="/articles/" class="nav-link">Blog</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Reverse Engineering - understanding Spies in Testing</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/javascript-spies.html#the-how" class="sidebar-link">The HOW</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/javascript-spies.html#creating-the-spy" class="sidebar-link">Creating the Spy</a></li><li class="sidebar-sub-header"><a href="/pages/javascript-spies.html#adding-matcher-tohavebeencalled" class="sidebar-link">Adding matcher toHaveBeenCalled()</a></li><li class="sidebar-sub-header"><a href="/pages/javascript-spies.html#adding-matcher-tohavebeencalledtimes" class="sidebar-link">Adding matcher toHaveBeenCalledTimes()</a></li><li class="sidebar-sub-header"><a href="/pages/javascript-spies.html#adding-matcher-tohavebeencalledwith" class="sidebar-link">Adding matcher toHaveBeenCalledWith()</a></li><li class="sidebar-sub-header"><a href="/pages/javascript-spies.html#reset-the-final-piece" class="sidebar-link">Reset, the final piece</a></li></ul></li><li><a href="/pages/javascript-spies.html#summary" class="sidebar-link">Summary</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/javascript-spies.html#full-code" class="sidebar-link">Full code</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="reverse-engineering-understanding-spies-in-testing"><a href="#reverse-engineering-understanding-spies-in-testing" aria-hidden="true" class="header-anchor">#</a> Reverse Engineering - understanding Spies in Testing</h1> <p>Follow me on <a href="https://twitter.com/chris_noring" target="_blank" rel="noopener noreferrer">Twitter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, happy to take your suggestions on topics or improvements /Chris</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/8zip3uj7t1n8o1qs54bn.jpg" alt=""></p> <blockquote><p>We use a spy to not only mock a response from a dependency but to ensure that our dependency has been correctly called. With correct we mean we mean the number of times, the correct type and number of arguments. There is a lot we can verify to ensure our code behaves correctly. This exercise is about understanding Spies in Jasmine, what goes on under the hood</p></blockquote> <p>In this article we are looking to explain:</p> <ul><li><strong>WHY</strong>, Understand WHY we use Spies and what they are good far</li> <li><strong>WHAT</strong>, Explain what Spies can do for us</li> <li><strong>HOW</strong>, uncover how they must be working under the hood but attempt to reverse engineering their public API</li></ul> <p>TLDR If you just want to see the implementation and don't care for reading how we got there then scroll to the bottom where the full code is. ðŸ˜ƒ</p> <p>##Â Why Spies</p> <p>Let's set the scene. We have a business-critical function in which we want to ship an order to a user. It's imperative that we get paid before shipping the order. Any changes to this code should be caught by our spy that we are about to implement.</p> <p>The code looks like this:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">makeOrder</span><span class="token punctuation">(</span>
  <span class="token parameter">paymentService<span class="token punctuation">,</span> 
  shippingService<span class="token punctuation">,</span> 
  address<span class="token punctuation">,</span> 
  amount<span class="token punctuation">,</span> 
  creditCard</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> paymentRef <span class="token operator">=</span> <span class="token keyword">await</span> paymentService<span class="token punctuation">.</span><span class="token function">charge</span><span class="token punctuation">(</span>creditCard<span class="token punctuation">,</span> amount<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>paymentService<span class="token punctuation">.</span><span class="token function">isPaid</span><span class="token punctuation">(</span>paymentRef<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    shippingService<span class="token punctuation">.</span><span class="token function">shipTo</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>We have the function <code>makeOrder()</code>. <code>makeOrder()</code> gets help from two different dependencies a <code>shippingService</code> and a <code>paymentService</code>. It's critical that the <code>paymentService</code> is being invoked to check that we have gotten paid before we ship the merchandise, otherwise it's just bad for business.</p> <p>It's also important that we at some point  call the <code>shippingService</code> to ensure the items gets delivered. Now, it's very seldom the code is this clear so you see exactly what it does and the consequences of removing any of the below code. The point is we need to write tests for the below code and we need spies to verify that our code is being called directly.</p> <p>In short:</p> <blockquote><p>Spies are about <code>asserting behavior</code> over asserting on results</p></blockquote> <p>##Â What</p> <p>Ok so we've mentioned in the first few lines of this article that Spies can help us check how many times a dependency is called, with what arguments and so on but let's try to list all the features that we know of in Jasmine Spies:</p> <ul><li><strong>Called</strong>, verify it has been called</li> <li><strong>Args</strong>, verify it has been called with a certain argument</li> <li><strong>Times called</strong>, verify the number of times it has been called</li> <li><strong>Times called and args</strong>, verify all the number of times it was called and all the arguments used</li> <li><strong>Mocking</strong>, return with a mocked value</li> <li><strong>Restore</strong>, because spies replace the original functionality we will need to restore our dependency to its original implementation at some point</li></ul> <p>That's quite a list of features and it should be able to help us assert the behavior on the above <code>makeOrder()</code>.</p> <h2 id="the-how"><a href="#the-how" aria-hidden="true" class="header-anchor">#</a> The HOW</h2> <p>This is where we start looking at Jasmine Spies and what the public API looks like. From there we will start to sketch out what an implementation could look like.</p> <p>Ok then. In Jasmine we create a Spy by calling code like this:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> apiService <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Then we use it inside of a test like this:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// arrange</span>
  <span class="token function">spyOn</span><span class="token punctuation">(</span>apiService<span class="token punctuation">,</span> <span class="token string">'fetchData'</span><span class="token punctuation">)</span>

  <span class="token comment">// act</span>
  <span class="token function">doSomething</span><span class="token punctuation">(</span>apiService<span class="token punctuation">.</span>fetchData<span class="token punctuation">)</span>

  <span class="token comment">// assert</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>apiService<span class="token punctuation">.</span>fetchData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>As you can see above we have three different steps that we need to care about.</p> <ol><li><strong>Creating</strong> the spy with <code>spyOn()</code></li> <li><strong>Invoking</strong> the spy</li> <li><strong>Asserting</strong> that the spy has been called</li></ol> <p>Let's start implementing</p> <h3 id="creating-the-spy"><a href="#creating-the-spy" aria-hidden="true" class="header-anchor">#</a> Creating the Spy</h3> <p>By looking at how it's used you realize that what you are replacing is one real function for a mocked function. Which means WHAT we end up assigning to <code>apiService.fetchData</code> <strong>must be a function</strong>.</p> <p>The other part of the puzzle is how we assert that it has been called. We have the following line to consider:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">expect</span><span class="token punctuation">(</span>apiService<span class="token punctuation">.</span>fetchData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>At this point we need to start implementing that line, like so:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">expect</span><span class="token punctuation">(</span><span class="token parameter">spy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      spy<span class="token punctuation">.</span><span class="token function">calledTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>WAIT. You just said that <code>apiService.fetchData</code> is a function. Yet in <code>expect()</code> you send it in and call <code>calledTimes()</code> on it like it was an object. I'm lost ðŸ˜¦</p></blockquote> <p>Ah, I see. You probably have a background from an OO language like C# or Java right?</p> <blockquote><p>How did you know?</p></blockquote> <p>In those languages you are either an object or a function, never both. But we are in JavaScript and JavaScript state that:</p> <p><em>Functions are function objects. In JavaScript, anything that is not a primitive type ( undefined , null , boolean , number , or string ) is an object</em>.</p> <p>Which means our spy, is a function but it has methods and properties on it like it was an object..</p> <blockquote><p>Niiice. and weird..</p></blockquote> <p>Ok then. With that knowledge, we can start implementing.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// spy.js</span>

<span class="token keyword">function</span> <span class="token function">spy</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  times <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  old <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">spy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    times<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  spy<span class="token punctuation">.</span><span class="token function-variable function">calledTimes</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> times<span class="token punctuation">;</span>

  obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> spy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">function</span> <span class="token function">spyOn</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">spy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  spyOn
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><code>spyOn()</code> calls <code>spy()</code> that internally creates the function <code>_spy()</code> that has knowledge of the variable <code>times</code> and expose the public method <code>calledTime()</code>. Then we end up assigning <code>_spy</code> to the object whose function we want to replace.</p> <h3 id="adding-matcher-tohavebeencalled"><a href="#adding-matcher-tohavebeencalled" aria-hidden="true" class="header-anchor">#</a> Adding matcher <code>toHaveBeenCalled()</code></h3> <p>Let's create the file <code>util.js</code> and have it look like so:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// util.js</span>

<span class="token keyword">function</span> <span class="token function">it</span><span class="token punctuation">(</span><span class="token parameter">testName<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>testName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">expect</span><span class="token punctuation">(</span><span class="token parameter">spy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> result <span class="token operator">=</span> spy<span class="token punctuation">.</span><span class="token function">calledTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'spy was called'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'spy was NOT called'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  it<span class="token punctuation">,</span> 
  expect
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>As you can see it just contains a very light implementation of <code>expect()</code> and <code>it()</code> method. Let's also create a <code>demo.js</code> file that tests our implementation:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// demo.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> spyOn <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./spy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> it<span class="token punctuation">,</span> expect <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">impl</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  obj<span class="token punctuation">.</span><span class="token function">calc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'test spy'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// arrange</span>
  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">calc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">spyOn</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'calc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// act</span>
  <span class="token function">impl</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// assert</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>calc<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>We have great progress already but let's look at how we can improve things.</p> <h3 id="adding-matcher-tohavebeencalledtimes"><a href="#adding-matcher-tohavebeencalledtimes" aria-hidden="true" class="header-anchor">#</a> Adding matcher <code>toHaveBeenCalledTimes()</code></h3> <p>This matcher have pretty much written itself already as we are keeping track of the number of times we call something. Simply add the following code to our <code>it()</code> function, in <code>util.js</code> like so:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token parameter">times</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> spy<span class="token punctuation">.</span><span class="token function">calledTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">==</span> times<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`success, spy was called </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>times<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`fail, expected spy to be called: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>times<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> but was: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="adding-matcher-tohavebeencalledwith"><a href="#adding-matcher-tohavebeencalledwith" aria-hidden="true" class="header-anchor">#</a> Adding matcher <code>toHaveBeenCalledWith()</code></h3> <p>Now this matcher wants us to verify that we can tell what our spy has been called with and is used like this:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">expect</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>someMethod<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token string">'param'</span><span class="token punctuation">,</span> <span class="token string">'param2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Let's revisit our implementation of the <code>spy()</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// excerpt from spy.js</span>

<span class="token keyword">function</span> <span class="token function">spy</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  times <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  old <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">spy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    times<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  spy<span class="token punctuation">.</span><span class="token function-variable function">calledTimes</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> times<span class="token punctuation">;</span>

  obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> spy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>We can see that we capture the number of times something is called through the variable <code>times</code> but we want to change that slightly. Instead of using a variable that stores a number let's instead replace that with an array like so:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// spy-with-args.js</span>

<span class="token keyword">function</span> <span class="token function">spy</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> calls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token keyword">function</span> <span class="token function">_spy</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    calls<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      args<span class="token punctuation">:</span> params
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  _spy<span class="token punctuation">.</span><span class="token function-variable function">calledTimes</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> calls<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  _spy<span class="token punctuation">.</span>_calls <span class="token operator">=</span> calls<span class="token punctuation">;</span>

  obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> _spy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>As you can see in thee <code>_spy()</code> method we collect all the input parameters and adds them to an array <code>calls</code>. <code>calls</code> will remember not only the number of invocations but what argument each invocation was done with.</p> <p><strong>Creating the matcher</strong></p> <p>To test that it stores all invocation and their argument lets create another <em>matcher</em> function in our <code>expect()</code> method and call it <code>toHaveBeenCalledWith()</code>. Now the requirements for it is that our spy should have been called with these args at some point. It doesn't say what iteration so that means we can loop through our <code>calls</code> array until we find a match.</p> <p>Let's add our matcher to the method <code>it()</code> in our <code>utils.js</code>, like so:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// excerpt from util.js</span>
<span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> spy<span class="token punctuation">.</span>_calls<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> callArgs <span class="token operator">=</span> spy<span class="token punctuation">.</span>_calls<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>args<span class="token punctuation">;</span>
    <span class="token keyword">const</span> equal <span class="token operator">=</span> params<span class="token punctuation">.</span>length <span class="token operator">===</span> callArgs<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> callArgs<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
      <span class="token keyword">const</span> res <span class="token operator">=</span> value <span class="token operator">===</span> params<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>equal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`success, spy was called with </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> `</span></span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`fail, spy was NOT called with </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> spy was invoked with:`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>spy<span class="token punctuation">.</span><span class="token function">getInvocations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>Above you can see how we compare <code>params</code>, which is what we call it with to each of the arguments in our invocations on the spy.</p> <p>Now, let's add some code to <code>demo.js</code> and our test method invocation, so we try out our new matcher, like so:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token comment">// excerpt from demo.js</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'test spy'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// arrange</span>
  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">calc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">spyOn</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'calc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// act</span>
  <span class="token function">impl</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// assert</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>calc<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>calc<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token string">'one'</span><span class="token punctuation">,</span> <span class="token string">'two'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>calc<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token string">'three'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>calc<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token string">'one'</span><span class="token punctuation">,</span> <span class="token string">'two'</span><span class="token punctuation">,</span> <span class="token string">'three'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>Running this in the terminal we get:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/lebeq3o7ata3kmcxl7no.png" alt=""></p> <p>We can see that it works like a charm. It succeeds on the two first ones and fails on the last one, as it should.</p> <h3 id="reset-the-final-piece"><a href="#reset-the-final-piece" aria-hidden="true" class="header-anchor">#</a> Reset, the final piece</h3> <p>We got one more piece of functionality we would like to add, namely the ability to reset our implementation. Now, this is probably the easiest thing we do. Let's visit our <code>spy-with-args.js</code> file. We need to do the following:</p> <ol><li>Add a reference to the old implementation</li> <li>Add a method <code>reset()</code> that points us back to our original implementation</li></ol> <p><strong>Add a reference</strong></p> <p>Inside of our <code>spy()</code> function add this line:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> old <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>This will save the implementation to the variable <code>old</code></p> <p><strong>Add <code>reset()</code> method</strong></p> <p>Just add the following line:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>_spy<span class="token punctuation">.</span><span class="token function-variable function">reset</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> old<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>The <code>spy()</code> method should now look like so:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">spy</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> calls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> old <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">_spy</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    calls<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      args<span class="token punctuation">:</span> params
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  _spy<span class="token punctuation">.</span><span class="token function-variable function">reset</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> old<span class="token punctuation">;</span>
  _spy<span class="token punctuation">.</span><span class="token function-variable function">calledTimes</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> calls<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  _spy<span class="token punctuation">.</span><span class="token function-variable function">getInvocations</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    calls<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">call<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      str<span class="token operator">+=</span> <span class="token template-string"><span class="token string">`Invocation </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, args: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>call<span class="token punctuation">.</span>args<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> \n`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> str<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  _spy<span class="token punctuation">.</span>_calls <span class="token operator">=</span> calls<span class="token punctuation">;</span>

  obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> _spy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="summary"><a href="#summary" aria-hidden="true" class="header-anchor">#</a> Summary</h2> <p>We've come to the end of the line.
We've implemented a spy from the beginning. Additionally, we've explained how <em>almost</em> everything is an object which made it possible to implement it the way we did.</p> <p>The end result is a spy that stores all the invocations and the parameters it was called with. We've also managed to create three different matchers that test whether our spy was called, how many times it was called and with what arguments.</p> <p>All in all a successful adventure into understanding the nature of a spy.</p> <p>We do realize that this is just a starter for something and taking it to production means we should probably support things like comparing whether something was called with an object, supporting, mocking and so on. I leave that up to you as an exercise.</p> <p>As another take-home exercise, see if you can write tests for the function <code>makeOrder()</code> that we mentioned in the beginning.</p> <h3 id="full-code"><a href="#full-code" aria-hidden="true" class="header-anchor">#</a> Full code</h3> <p>Here is the full code in case I lost you during the way:</p> <p><strong>util.js, containing our matcher functions</strong></p> <p>Our file containing our functions <code>it()</code> and <code>expect()</code> and its matchers.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// util.js</span>

<span class="token keyword">function</span> <span class="token function">it</span><span class="token punctuation">(</span><span class="token parameter">testName<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>testName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">expect</span><span class="token punctuation">(</span><span class="token parameter">spy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> result <span class="token operator">=</span> spy<span class="token punctuation">.</span><span class="token function">calledTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'success,spy was called'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'fail, spy was NOT called'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token parameter">times</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> result <span class="token operator">=</span> spy<span class="token punctuation">.</span><span class="token function">calledTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">==</span> times<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`success, spy was called </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>times<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`fail, expected spy to be called: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>times<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> but was: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> spy<span class="token punctuation">.</span>_calls<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> callArgs <span class="token operator">=</span> spy<span class="token punctuation">.</span>_calls<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>args<span class="token punctuation">;</span>
        <span class="token keyword">const</span> equal <span class="token operator">=</span> params<span class="token punctuation">.</span>length <span class="token operator">===</span> callArgs<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> callArgs<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
          <span class="token keyword">const</span> res <span class="token operator">=</span> value <span class="token operator">===</span> params<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>equal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`success, spy was called with </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> `</span></span><span class="token punctuation">)</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`fail, spy was NOT called with </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> spy was invoked with:`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>spy<span class="token punctuation">.</span><span class="token function">getInvocations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  it<span class="token punctuation">,</span> 
  expect
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p><strong>spy implementation</strong></p> <p>Our spy implementation <code>spy-with-args.js</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">spyOn</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">spy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">spy</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> calls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> old <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">_spy</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    calls<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      args<span class="token punctuation">:</span> params
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  _spy<span class="token punctuation">.</span><span class="token function-variable function">reset</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> old<span class="token punctuation">;</span>
  _spy<span class="token punctuation">.</span><span class="token function-variable function">calledTimes</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> calls<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  _spy<span class="token punctuation">.</span><span class="token function-variable function">getInvocations</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    calls<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">call<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      str<span class="token operator">+=</span> <span class="token template-string"><span class="token string">`Invocation </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, args: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>call<span class="token punctuation">.</span>args<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> \n`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> str<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  _spy<span class="token punctuation">.</span>_calls <span class="token operator">=</span> calls<span class="token punctuation">;</span>

  obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> _spy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  spyOn
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p><strong>demo.js, for testing it out</strong></p> <p>and lastly our <code>demo.js</code> file:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> spyOn <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./spy-with-args'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> it<span class="token punctuation">,</span> expect <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">impl</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  obj<span class="token punctuation">.</span><span class="token function">calc</span><span class="token punctuation">(</span><span class="token string">'one'</span><span class="token punctuation">,</span> <span class="token string">'two'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  obj<span class="token punctuation">.</span><span class="token function">calc</span><span class="token punctuation">(</span><span class="token string">'three'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'test spy'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// arrange</span>
  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">calc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">spyOn</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'calc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// act</span>
  <span class="token function">impl</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// assert</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>calc<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>calc<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token string">'one'</span><span class="token punctuation">,</span> <span class="token string">'two'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>calc<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token string">'three'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>calc<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token string">'one'</span><span class="token punctuation">,</span> <span class="token string">'two'</span><span class="token punctuation">,</span> <span class="token string">'three'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.47a3764b.js" defer></script><script src="/assets/js/5.218403d0.js" defer></script><script src="/assets/js/4.5f5dd8b1.js" defer></script><script src="/assets/js/44.95f423de.js" defer></script>
  </body>
</html>
