<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Joi â€” awesome code validation for Node.js and Express</title>
    <meta name="description" content="[object Object]">
    <head link="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-abap.js"></head>
    
    <link rel="preload" href="/assets/css/0.styles.f3cdb744.css" as="style"><link rel="preload" href="/assets/js/app.8c96a5ac.js" as="script"><link rel="preload" href="/assets/js/9.20ba5650.js" as="script"><link rel="preload" href="/assets/js/4.b33b06f6.js" as="script"><link rel="preload" href="/assets/js/136.0b82340b.js" as="script"><link rel="prefetch" href="/assets/js/1.76e1fa2c.js"><link rel="prefetch" href="/assets/js/10.e78e8506.js"><link rel="prefetch" href="/assets/js/100.9f271bb1.js"><link rel="prefetch" href="/assets/js/101.160d2e9a.js"><link rel="prefetch" href="/assets/js/102.6d37d64b.js"><link rel="prefetch" href="/assets/js/103.89772e5e.js"><link rel="prefetch" href="/assets/js/104.cff87ef0.js"><link rel="prefetch" href="/assets/js/105.e9f14a21.js"><link rel="prefetch" href="/assets/js/106.c2d324ee.js"><link rel="prefetch" href="/assets/js/107.e56bde0a.js"><link rel="prefetch" href="/assets/js/108.55239339.js"><link rel="prefetch" href="/assets/js/109.bdab2a38.js"><link rel="prefetch" href="/assets/js/11.836ffd95.js"><link rel="prefetch" href="/assets/js/110.db4d057c.js"><link rel="prefetch" href="/assets/js/111.46445704.js"><link rel="prefetch" href="/assets/js/112.c1f25142.js"><link rel="prefetch" href="/assets/js/113.49fa1ce6.js"><link rel="prefetch" href="/assets/js/114.9b04881b.js"><link rel="prefetch" href="/assets/js/115.9fc9e232.js"><link rel="prefetch" href="/assets/js/116.90a64bf4.js"><link rel="prefetch" href="/assets/js/117.23d35494.js"><link rel="prefetch" href="/assets/js/118.47c182d8.js"><link rel="prefetch" href="/assets/js/119.5ff673f9.js"><link rel="prefetch" href="/assets/js/12.0ed640a1.js"><link rel="prefetch" href="/assets/js/120.50d25635.js"><link rel="prefetch" href="/assets/js/121.7e97bf0f.js"><link rel="prefetch" href="/assets/js/122.c2faa5b2.js"><link rel="prefetch" href="/assets/js/123.178e669e.js"><link rel="prefetch" href="/assets/js/124.26c930f2.js"><link rel="prefetch" href="/assets/js/125.c343cfda.js"><link rel="prefetch" href="/assets/js/126.517d61f6.js"><link rel="prefetch" href="/assets/js/127.86cce6e8.js"><link rel="prefetch" href="/assets/js/128.3c8f7db6.js"><link rel="prefetch" href="/assets/js/129.586ef1be.js"><link rel="prefetch" href="/assets/js/13.9b870990.js"><link rel="prefetch" href="/assets/js/130.c932cc50.js"><link rel="prefetch" href="/assets/js/131.4e2fe734.js"><link rel="prefetch" href="/assets/js/132.1b0009d2.js"><link rel="prefetch" href="/assets/js/133.45065461.js"><link rel="prefetch" href="/assets/js/134.5e7a52d1.js"><link rel="prefetch" href="/assets/js/135.dac10c72.js"><link rel="prefetch" href="/assets/js/137.5f16faab.js"><link rel="prefetch" href="/assets/js/138.c2345556.js"><link rel="prefetch" href="/assets/js/139.e7e2f4fc.js"><link rel="prefetch" href="/assets/js/14.4794068b.js"><link rel="prefetch" href="/assets/js/140.67e7e471.js"><link rel="prefetch" href="/assets/js/141.7a130991.js"><link rel="prefetch" href="/assets/js/142.babf56eb.js"><link rel="prefetch" href="/assets/js/143.eb8e2fdc.js"><link rel="prefetch" href="/assets/js/144.28b1ecf4.js"><link rel="prefetch" href="/assets/js/145.961ac7e9.js"><link rel="prefetch" href="/assets/js/146.afb0cb53.js"><link rel="prefetch" href="/assets/js/147.7daacdff.js"><link rel="prefetch" href="/assets/js/148.5be44647.js"><link rel="prefetch" href="/assets/js/149.dfd05b01.js"><link rel="prefetch" href="/assets/js/15.e392c70f.js"><link rel="prefetch" href="/assets/js/150.9beacbeb.js"><link rel="prefetch" href="/assets/js/151.94914b22.js"><link rel="prefetch" href="/assets/js/152.98fb8ae8.js"><link rel="prefetch" href="/assets/js/153.e65e43a4.js"><link rel="prefetch" href="/assets/js/154.9257ceb0.js"><link rel="prefetch" href="/assets/js/155.d95701eb.js"><link rel="prefetch" href="/assets/js/156.749f7732.js"><link rel="prefetch" href="/assets/js/16.019de8ce.js"><link rel="prefetch" href="/assets/js/17.c628a80f.js"><link rel="prefetch" href="/assets/js/18.4ab7403e.js"><link rel="prefetch" href="/assets/js/19.ae2840ee.js"><link rel="prefetch" href="/assets/js/20.f35f7928.js"><link rel="prefetch" href="/assets/js/21.b56d9e83.js"><link rel="prefetch" href="/assets/js/22.ddc02800.js"><link rel="prefetch" href="/assets/js/23.f071d7ac.js"><link rel="prefetch" href="/assets/js/24.32bba910.js"><link rel="prefetch" href="/assets/js/25.e37583c4.js"><link rel="prefetch" href="/assets/js/26.a10546b0.js"><link rel="prefetch" href="/assets/js/27.a14dc72b.js"><link rel="prefetch" href="/assets/js/28.523ca887.js"><link rel="prefetch" href="/assets/js/29.a8869a85.js"><link rel="prefetch" href="/assets/js/3.95140222.js"><link rel="prefetch" href="/assets/js/30.d6dee1ef.js"><link rel="prefetch" href="/assets/js/31.7d7e60c3.js"><link rel="prefetch" href="/assets/js/32.7ed90aa0.js"><link rel="prefetch" href="/assets/js/33.bc985518.js"><link rel="prefetch" href="/assets/js/34.0a3b552f.js"><link rel="prefetch" href="/assets/js/35.40f3020b.js"><link rel="prefetch" href="/assets/js/36.5fb6f635.js"><link rel="prefetch" href="/assets/js/37.bbfe4251.js"><link rel="prefetch" href="/assets/js/38.78dce1f3.js"><link rel="prefetch" href="/assets/js/39.64d08d4e.js"><link rel="prefetch" href="/assets/js/40.18bf0852.js"><link rel="prefetch" href="/assets/js/41.4cce3a1c.js"><link rel="prefetch" href="/assets/js/42.b53de554.js"><link rel="prefetch" href="/assets/js/43.c5471ea1.js"><link rel="prefetch" href="/assets/js/44.a5a36f06.js"><link rel="prefetch" href="/assets/js/45.931abcf1.js"><link rel="prefetch" href="/assets/js/46.29a07c70.js"><link rel="prefetch" href="/assets/js/47.ea4a708d.js"><link rel="prefetch" href="/assets/js/48.e01067bc.js"><link rel="prefetch" href="/assets/js/49.40bc9c85.js"><link rel="prefetch" href="/assets/js/5.44d1fb4e.js"><link rel="prefetch" href="/assets/js/50.f591266f.js"><link rel="prefetch" href="/assets/js/51.77d16183.js"><link rel="prefetch" href="/assets/js/52.ab81ebd7.js"><link rel="prefetch" href="/assets/js/53.27264aee.js"><link rel="prefetch" href="/assets/js/54.733a10fa.js"><link rel="prefetch" href="/assets/js/55.90fb8ebb.js"><link rel="prefetch" href="/assets/js/56.23b35d89.js"><link rel="prefetch" href="/assets/js/57.7def6b4a.js"><link rel="prefetch" href="/assets/js/58.89ab3d68.js"><link rel="prefetch" href="/assets/js/59.4fa61218.js"><link rel="prefetch" href="/assets/js/6.67cc1f3f.js"><link rel="prefetch" href="/assets/js/60.53f7b467.js"><link rel="prefetch" href="/assets/js/61.95a028c2.js"><link rel="prefetch" href="/assets/js/62.2cd74190.js"><link rel="prefetch" href="/assets/js/63.7cb0dbb1.js"><link rel="prefetch" href="/assets/js/64.8ebf3831.js"><link rel="prefetch" href="/assets/js/65.747f44ba.js"><link rel="prefetch" href="/assets/js/66.a224a0e5.js"><link rel="prefetch" href="/assets/js/67.b46f3f0e.js"><link rel="prefetch" href="/assets/js/68.42484148.js"><link rel="prefetch" href="/assets/js/69.83c2b112.js"><link rel="prefetch" href="/assets/js/7.30873a64.js"><link rel="prefetch" href="/assets/js/70.f4d3718c.js"><link rel="prefetch" href="/assets/js/71.002d32ef.js"><link rel="prefetch" href="/assets/js/72.869bc145.js"><link rel="prefetch" href="/assets/js/73.b3b74d9d.js"><link rel="prefetch" href="/assets/js/74.03102f8d.js"><link rel="prefetch" href="/assets/js/75.4e93e65b.js"><link rel="prefetch" href="/assets/js/76.e137a1da.js"><link rel="prefetch" href="/assets/js/77.614596eb.js"><link rel="prefetch" href="/assets/js/78.e801891e.js"><link rel="prefetch" href="/assets/js/79.6a1f078a.js"><link rel="prefetch" href="/assets/js/8.988484b0.js"><link rel="prefetch" href="/assets/js/80.0b0176a2.js"><link rel="prefetch" href="/assets/js/81.a5d77e4c.js"><link rel="prefetch" href="/assets/js/82.f15537f4.js"><link rel="prefetch" href="/assets/js/83.088ef873.js"><link rel="prefetch" href="/assets/js/84.af0157a0.js"><link rel="prefetch" href="/assets/js/85.eab9b9ef.js"><link rel="prefetch" href="/assets/js/86.9a4955c0.js"><link rel="prefetch" href="/assets/js/87.d8b99fa7.js"><link rel="prefetch" href="/assets/js/88.ff88d7fb.js"><link rel="prefetch" href="/assets/js/89.61b24378.js"><link rel="prefetch" href="/assets/js/90.249cfadf.js"><link rel="prefetch" href="/assets/js/91.6bca8497.js"><link rel="prefetch" href="/assets/js/92.964c7e9b.js"><link rel="prefetch" href="/assets/js/93.fa43b929.js"><link rel="prefetch" href="/assets/js/94.660e6988.js"><link rel="prefetch" href="/assets/js/95.667d0e2c.js"><link rel="prefetch" href="/assets/js/96.8d5a62c9.js"><link rel="prefetch" href="/assets/js/97.02285dcd.js"><link rel="prefetch" href="/assets/js/98.4bb921ce.js"><link rel="prefetch" href="/assets/js/99.20cbd72a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f3cdb744.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/author/" class="nav-link">Author</a></div><div class="nav-item"><a href="/articles/" class="nav-link">Blog</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/author/" class="nav-link">Author</a></div><div class="nav-item"><a href="/articles/" class="nav-link">Blog</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Joi â€” awesome code validation for Node.js and Express</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/joi.html#introducing-joi" class="sidebar-link">Introducing Joi</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/joi.html#node-js-express-and-joi" class="sidebar-link">Node.js Express and Joi</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/joi.html#building-a-middleware" class="sidebar-link">Building a middleware</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/joi.html#testing-it-out" class="sidebar-link">Testing it out</a></li><li class="sidebar-sub-header"><a href="/pages/joi.html#support-router-and-query-parameters" class="sidebar-link">Support Router and Query parameters</a></li><li class="sidebar-sub-header"><a href="/pages/joi.html#adding-router-parameters-support" class="sidebar-link">Adding router parameters support</a></li></ul></li><li><a href="/pages/joi.html#summary" class="sidebar-link">Summary</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="joi-â€”-awesome-code-validation-for-node-js-and-express"><a href="#joi-â€”-awesome-code-validation-for-node-js-and-express" aria-hidden="true" class="header-anchor">#</a> Joi â€” awesome code validation for Node.js and Express</h1> <p>Follow me on <a href="https://twitter.com/chris_noring" target="_blank" rel="noopener noreferrer">Twitter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, happy to take your suggestions on topics or improvements /Chris</p> <p><img src="https://miro.medium.com/max/1400/0*tkqNgTayo-POGGuI.jpg" alt=""></p> <blockquote><p>Validation of data is an interesting topic, we tend to write code that looks really horrible in the sense that it contains a lot of checks. There are different situations when we need to perform these checks like validating a response from a backend endpoint or maybe verifying what goes into our REST API wonâ€™t break our code. We will focus on the latter, how to validate our API.</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">.</span>parameterX<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">'parameterX missing'</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
<span class="token keyword">try</span> <span class="token punctuation">{</span> 
  <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>parameterX<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">'parameterX should be number'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex">/[a-z]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>parameterY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">'parameterY should be lower caps text'</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>I think you get the idea from the above <em>cringe-worthy</em> code. We tend to perform a lot of tests on our parameters to ensure they are the right and/or their values contains the allowed values.</p> <p>As developers we tend to feel really bad about code like this, so we either start writing a lib for this or we turn to our old friend NPM and hope that some other developer have felt this pain and had too much time on their hands and made a lib that you could use.</p> <p>There are many libs that will do this for you. I aim to describe a specific one called Joi.</p> <blockquote><p>https://github.com/hapijs/joi</p></blockquote> <p>Throughout this article we will take the following journey together:</p> <ul><li><strong>Have a look</strong> at Joiâ€™s features</li> <li><strong>See</strong> how we can use Joi in the backend in a Request pipeline</li> <li><strong>Improve</strong> even further by building a middleware for Express in Node.js</li></ul> <h2 id="introducing-joi"><a href="#introducing-joi" aria-hidden="true" class="header-anchor">#</a> Introducing Joi</h2> <p>Installing Joi is quite easy. We just need to type:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm install joi
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>After that, we are ready to use it. Letâ€™s have a quick look at how we use it. The first thing we do is import it and then we set up some rules, like so:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Joi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'joi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> schema <span class="token operator">=</span> Joi<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
  name<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">alphanum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  birthyear<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1970</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">2013</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> dataToValidate <span class="token operator">=</span> <span class="token punctuation">{</span> 
  name <span class="token string">'chris'</span><span class="token punctuation">,</span> 
  birthyear<span class="token punctuation">:</span> <span class="token number">1971</span> 
<span class="token punctuation">}</span> 
<span class="token keyword">const</span> result <span class="token operator">=</span> Joi<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>dataToValidate<span class="token punctuation">,</span> schema<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// result.error == null means valid</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>What we are looking at above is us doing the following:</p> <ul><li><strong>constructing</strong> a schema, our call to Joi.object(),</li> <li><strong>validating</strong> our data, our call to <code>Joi.validate()</code> with dataToValidate and schema as input parameters</li></ul> <p>Ok, now we understand the basic motions. What else can we do?</p> <p>Well Joi supports all sorts of primitives as well as Regex and can be nested to any depth. Letâ€™s list some different constructs it supports:</p> <ul><li><strong>string</strong>, this says it needs to be of type string, and we use it like so <code>Joi.string()</code></li> <li><strong>number</strong>, Joi.number() and also supporting helper operations such as min() and max(), like so <code>Joi.number().min(1).max(10)</code></li> <li><strong>required</strong>, we can say whether a property is required with the help of the method required, like so <code>Joi.string().required()</code></li> <li><strong>any</strong>, this means it could be any type, usually we tend to use it with the helper allow() that specifies what it can contain, like so, <code>Joi.any().allow('a')</code></li> <li><strong>optional</strong>, this is strictly speaking not a type but has an interesting effect. If you specify for example prop : <code>Joi.string().optional</code>. If we don't provide prop then everybody's happy. However if we do provide it and make it an integer the validation will fail</li> <li><strong>array</strong>, we can check wether the property is an array of say strings, then it would look like this <code>Joi.array().items(Joi.string().valid('a', 'b')</code></li> <li><strong>regex</strong>, it supports pattern matching with RegEx as well like so <code>Joi.string().regex(/^[a-zA-Z0-9]{3,30}$/)</code></li></ul> <p>The whole API for Joi is enormous. I suggest to have a look and see if there is a helper function that can solve whatever case you have that Iâ€™m not showing above</p> <p>Joi API</p> <blockquote><p>https://github.com/hapijs/joi/blob/v14.3.1/API.md</p></blockquote> <p>##Â Nested types</p> <p>Ok, so we have only shown how to declare a schema so far that is one level deep. We did so by calling the following:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Joi<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>This stated that our data is an object. Then we added some properties to our object like so:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Joi<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
  name<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">alphanum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  birthyear<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1970</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">2013</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Now, nested structures are really more of the same. Letâ€™s create an entirely new schema, a schema for a blog post, looking like this:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> blogPostSchema <span class="token operator">=</span> Joi<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
  title<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">alphanum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  description<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
  comments<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">items</span><span class="token punctuation">(</span>Joi<span class="token punctuation">.</span>object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
    description<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    author<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    grade<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> 
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>Note especially the <code>comments</code> property, that thing looks exactly like the outer call we first make and it is the same. Nesting is as easy as that.</p> <h2 id="node-js-express-and-joi"><a href="#node-js-express-and-joi" aria-hidden="true" class="header-anchor">#</a> Node.js Express and Joi</h2> <p>Libraries like these are great but wouldnâ€™t it be even better if we could use them in a more seamless way, like in a Request pipeline? Letâ€™s have a look firstly how we would use Joi in an Express app in Node.js:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Joi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'joi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/blog'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
  <span class="token keyword">const</span> <span class="token punctuation">{</span> body <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">;</span> <span class="token keyword">const</span> 
  blogSchema <span class="token operator">=</span> Joi<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
    title<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>required 
    description<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    authorId<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">const</span> result <span class="token operator">=</span> Joi<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> blogShema<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> result<span class="token punctuation">;</span> 
  <span class="token keyword">const</span> valid <span class="token operator">=</span> error <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>valid<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">422</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
      message<span class="token punctuation">:</span> <span class="token string">'Invalid request'</span><span class="token punctuation">,</span> 
      data<span class="token punctuation">:</span> body 
    <span class="token punctuation">}</span><span class="token punctuation">)</span> 
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
    <span class="token keyword">const</span> createdPost <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token function">createPost</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'Resource created'</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> createdPost <span class="token punctuation">}</span><span class="token punctuation">)</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>The above works. But we have to, for each route:</p> <ol><li>create a schema</li> <li>call <code>validate()</code></li></ol> <p>Itâ€™s, for lack of better word, lacking in elegance. We want something slick looking.</p> <h2 id="building-a-middleware"><a href="#building-a-middleware" aria-hidden="true" class="header-anchor">#</a> Building a middleware</h2> <p>Letâ€™s see if we canâ€™t rebuild it a bit to a middleware. Middlewares in Express is simply something we can stick into the request pipeline whenever we need it. In our case we would want to try and verify our request and early on determine whether it is worth proceeding with it or abort it.</p> <p>So letâ€™s look at a middleware. Itâ€™s just a function right:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">// handle our request } </span>
<span class="token keyword">const</span> <span class="token function-variable function">middleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// to be defined } </span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span> <span class="token string">'/blog'</span><span class="token punctuation">,</span> middleware<span class="token punctuation">,</span> handler <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>It would be neat if we could provide a schema to our middleware so all we had to do in the middleware function was something like this:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
  <span class="token keyword">const</span> result <span class="token operator">=</span> Joi<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> data<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>We could create a module with a factory function and module for all our schemas. Letâ€™s have a look at our factory function module first:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Joi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'joi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> <span class="token function-variable function">middleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">schema<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
  <span class="token keyword">const</span> <span class="token punctuation">{</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> Joi<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">,</span> schema<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">const</span> valid <span class="token operator">=</span> error <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>valid<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
    <span class="token keyword">const</span> <span class="token punctuation">{</span> details <span class="token punctuation">}</span> <span class="token operator">=</span> error<span class="token punctuation">;</span> 
    <span class="token keyword">const</span> message <span class="token operator">=</span> details<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">i</span> <span class="token operator">=&gt;</span> i<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">422</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token punctuation">:</span> message <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span> 
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> middleware<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>Letâ€™s thereafter create a module for all our schemas, like so:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// schemas.js </span>
<span class="token keyword">const</span> Joi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'joi'</span><span class="token punctuation">)</span> 
<span class="token keyword">const</span> schemas <span class="token operator">=</span> <span class="token punctuation">{</span> 
  blogPOST<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
    title<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>required 
    description<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">}</span><span class="token punctuation">)</span> 
  <span class="token comment">// define all the other schemas below </span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> schemas<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Ok then, letâ€™s head back to our application file:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app.js </span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span> 
<span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cors'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">3000</span> 
<span class="token keyword">const</span> schemas <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./schemas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> middleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./middleware'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">var</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;body-parser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello World!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/blog'</span><span class="token punctuation">,</span> <span class="token function">middleware</span><span class="token punctuation">(</span>schemas<span class="token punctuation">.</span>blogPOST<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'/update'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
 app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Example app listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="testing-it-out"><a href="#testing-it-out" aria-hidden="true" class="header-anchor">#</a> Testing it out</h3> <p>There are many ways to test this out. We could do a <code>fetch()</code> call from a browser console or use cURL and so on. We opt for using a chrome plugin called <code>Advanced REST Client</code>.</p> <p>Letâ€™s try to make a POST request to <code>/blog</code>. Remember our schema for this route said that title and description were mandatory so let's try to crash it, let's omit title and see what happens:</p> <p><img src="https://miro.medium.com/max/1400/0*i_8sHdkomgNkifcI.png" alt=""></p> <p>Aha, we get a <code>422</code> status code and the message title is required, so Joi does what it is supposed to. Just for safety sake let's re add title:</p> <p><img src="https://miro.medium.com/max/1400/0*rACkcVkFdN-v6HBp.png" alt=""></p> <p>Ok, happy days, it works again.</p> <h3 id="support-router-and-query-parameters"><a href="#support-router-and-query-parameters" aria-hidden="true" class="header-anchor">#</a> Support Router and Query parameters</h3> <p>Ok, great we can deal with BODY in POST request what about router parameters and query parameters and what would we like to validate with them:</p> <ul><li><strong>query parameters</strong>, here it makes sense to check that for example parameters like page and pageSize exist and is of type number. Imagine us doing a crazy request and our database contains a few million products, AOUCH ðŸ˜ƒ</li> <li><strong>router parameters</strong>, here it would make sense to first off check that we are getting a number if we should get a number that is ( we could be sending GUIDs for example ) and maybe check that we are not sending something that is obviously wrong like a 0 or something</li></ul> <p>###Â Adding query parameters support</p> <p>Ok, we know of query parameters in Express, that they reside under the <code>request.query</code>. So the simplest thing we could do here is to ensure our <code>middleware.js</code> takes another parameter, like so:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">middleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">schema<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>and our full code for <code>middleware.js</code> would, therefore, look like this:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Joi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'joi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> <span class="token function-variable function">middleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">schema<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
    <span class="token keyword">const</span> <span class="token punctuation">{</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> Joi<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>req<span class="token punctuation">[</span>property<span class="token punctuation">]</span><span class="token punctuation">,</span> schema<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">const</span> valid <span class="token operator">=</span> error <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>valid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 
    <span class="token keyword">else</span> <span class="token punctuation">{</span> 
      <span class="token keyword">const</span> <span class="token punctuation">{</span> details <span class="token punctuation">}</span> <span class="token operator">=</span> error<span class="token punctuation">;</span> 
      <span class="token keyword">const</span> message <span class="token operator">=</span> details<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">i</span> <span class="token operator">=&gt;</span> i<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">422</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token punctuation">:</span> message <span class="token punctuation">}</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span> 
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> middleware<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>This would mean we would have to have a look at <code>app.js</code> and change how we invoke our <code>middleware()</code> function. First off our POST request would now have to look like this:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
  <span class="token string">'/blog'</span><span class="token punctuation">,</span> 
  <span class="token function">middleware</span><span class="token punctuation">(</span>schemas<span class="token punctuation">.</span>blogPOST<span class="token punctuation">,</span> <span class="token string">'body'</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> 
  <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'/update'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>As you can see we add another argument body to our <code>middleware()</code> call.</p> <p>Letâ€™s now add the request whoâ€™s query parameters we are interested in:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
  <span class="token string">'/products'</span><span class="token punctuation">,</span> 
  <span class="token function">middleware</span><span class="token punctuation">(</span>schemas<span class="token punctuation">.</span>blogLIST<span class="token punctuation">,</span> <span class="token string">'query'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
  <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'/products'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">const</span> <span class="token punctuation">{</span> page<span class="token punctuation">,</span> pageSize <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span> 
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>As you can see all we have to do above is add the argument query. Lastly let's have a look at our <code>schemas.js</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// schemas.js </span>
<span class="token keyword">const</span> Joi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'joi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> schemas <span class="token operator">=</span> <span class="token punctuation">{</span> 
  blogPOST<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
    title<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    description<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    year<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
  blogLIST<span class="token punctuation">:</span> <span class="token punctuation">{</span> 
    page<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    pageSize<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> schemas<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>As you can see above we have added the <code>blogLIST</code> entry.</p> <p><strong>Testing it out</strong></p> <p>Letâ€™s head back to Advanced REST client and see what happens if we try to navigate to <code>/products</code> without adding the query parameters:</p> <p><img src="https://miro.medium.com/max/1400/0*RORElXdZ4WnkAEpD.png" alt=""></p> <p>As you can see Joi kicks in and tells us that <code>page</code> is missing.
Letâ€™s ensure <code>page</code> and <code>pageSize</code> is added to our URL and try it again:</p> <p><img src="https://miro.medium.com/max/1400/0*FB_CCIR3bg4pSxrT.png" alt=""></p> <p>Ok, everybody is happy again. ðŸ˜ƒ</p> <h3 id="adding-router-parameters-support"><a href="#adding-router-parameters-support" aria-hidden="true" class="header-anchor">#</a> Adding router parameters support</h3> <p>Just like with query parameters we just need to point out where we find our parameters, in Express those reside under <code>req.params</code>. Thanks to the works we already did with <code>middleware.js</code> we just need to update our <code>app.js</code> with our new route entry like so:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app.js </span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
  <span class="token string">'/products/:id'</span><span class="token punctuation">,</span> 
  <span class="token function">middleware</span><span class="token punctuation">(</span>schemas<span class="token punctuation">.</span>blogDETAIL<span class="token punctuation">,</span> <span class="token string">'params'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
  <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>  <span class="token punctuation">{</span> 
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;/products/:id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span> 
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>At this point we need to go into <code>schemas.js</code> and add the <code>blogDetail</code> entry so <code>schemas.js</code> should now look like the following:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// schemas.js</span>

<span class="token keyword">const</span> Joi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'joi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token keyword">const</span> schemas <span class="token operator">=</span> <span class="token punctuation">{</span> 
  blogPOST<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
    title<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    description<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    year<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
  blogLIST<span class="token punctuation">:</span> <span class="token punctuation">{</span> 
    page<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    pageSize<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span> 
  blogDETAIL<span class="token punctuation">:</span> <span class="token punctuation">{</span> 
   id<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> schemas<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>Try it out</strong></p> <p>The last step is trying it out so letâ€™s first test to navigate to <code>/products/abc</code>. That should throw an error, we are only OK with numbers over 0:</p> <p><img src="https://miro.medium.com/max/1400/0*XoibhNswi6kZjG7M.png" alt=""></p> <p>Ok, now for a URL stating <code>/products/0</code>, our other requirement:</p> <p><img src="https://miro.medium.com/max/1400/0*rFJVPbmkTks7IfPP.png" alt=""></p> <p>Also, that fails, as expected.</p> <h2 id="summary"><a href="#summary" aria-hidden="true" class="header-anchor">#</a> Summary</h2> <p>We have introduced the validation library Joi and presented some basic features and how to use it. Lastly, we have looked at how to create a middleware for Express and use Joi in a smart way.</p> <p>All in all, I hope this has been educational.</p> <p>###Â Further reading</p> <ul><li>Joi, official docs <a href="https://github.com/hapijs/joi" target="_blank" rel="noopener noreferrer">Official docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>Exhaustive blog post on Joi validation, if you need a more complex example, look at this <a href="https://scotch.io/tutorials/node-api-schema-validation-with-joi" target="_blank" rel="noopener noreferrer">Blog post<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/softchris/joi-example" target="_blank" rel="noopener noreferrer">Demo repository<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8c96a5ac.js" defer></script><script src="/assets/js/9.20ba5650.js" defer></script><script src="/assets/js/4.b33b06f6.js" defer></script><script src="/assets/js/136.0b82340b.js" defer></script>
  </body>
</html>
